<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý kho vải</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 15px; background-color: #f4f7fa; }
    .container { max-width: 800px; margin: auto; }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .nav-tabs { border-bottom: 2px solid #e0e7ff; }
    .nav-link { color: #495057; font-weight: 500; padding: 10px 20px; }
    .nav-link.active { background-color: #e0e7ff; color: #0d6efd; border-radius: 8px 8px 0 0; }
    .tab-content { padding: 20px; background: #fff; border-radius: 0 0 10px 10px; }
    #output { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px; font-size: 0.9em; }
    .table-container { max-height: 400px; overflow-y: auto; margin-top: 15px; }
    .table { font-size: 0.9em; }
    .table th, .table td { vertical-align: middle; }
    .btn { border-radius: 5px; font-size: 0.9em; padding: 10px 20px; }
    .form-control, .form-select { font-size: 0.9em; border-radius: 5px; }
    .form-section, .filter-section, .manage-section { margin-bottom: 25px; }
    .pagination-section { margin-top: 15px; display: flex; align-items: center; gap: 10px; }
    .pagination-btn { padding: 6px 12px; }
    .action-btn { padding: 5px 10px; font-size: 0.85em; margin-right: 5px; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .total-row { font-weight: bold; background-color: #e9ecef; }
    .file-input-wrapper { margin-top: 15px; }
    .file-input-wrapper input[type="file"] { width: 100%; padding: 8px; }
    @media (max-width: 576px) {
      body { padding: 10px; }
      .nav-link { padding: 8px 15px; font-size: 0.9em; }
      .tab-content { padding: 15px; }
      .btn { width: 100%; margin-bottom: 10px; padding: 12px; font-size: 1em; }
      .form-section h5, .filter-section h5 { font-size: 1em; }
      .table { font-size: 0.8em; }
      .row.g-3 > div { margin-bottom: 10px; }
      .filter-section .col-12, .filter-section .col-md-3 { margin-bottom: 10px; }
      .pagination-section { flex-direction: column; align-items: stretch; }
      .action-btn { padding: 8px; font-size: 0.9em; }
      .file-input-wrapper input[type="file"] { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4" style="font-size: 1.5em; color: #0d6efd;">Quản lý kho vải</h1>
    <div class="card">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input">Nhập liệu</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory">Tồn kho</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history">Lịch sử giao dịch</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage">Quản lý dữ liệu</button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="input">
          <div class="form-section">
            <h5>Nhập liệu</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="formType" class="form-label">Loại lệnh:</label>
                <select class="form-select" id="formType">
                  <option value="n">Nhập</option>
                  <option value="x">Xuất</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="formCode" class="form-label">Mã vải:</label>
                <input type="text" class="form-control" id="formCode" placeholder="VD: 950002">
              </div>
              <div class="col-md-2 col-12">
                <label for="formTrees" class="form-label">Số cây:</label>
                <input type="number" min="0" step="1" class="form-control" id="formTrees" value="0">
              </div>
              <div class="col-md-2 col-12">
                <label for="formMeters" class="form-label">Số mét:</label>
                <input type="number" step="0.1" class="form-control" id="formMeters" value="0.0">
              </div>
              <div class="col-md-2 col-12">
                <label for="formDate" class="form-label">Ngày:</label>
                <input type="date" class="form-control" id="formDate">
              </div>
            </div>
            <button class="btn btn-primary mt-3" id="processFormButton">Thực hiện</button>
          </div>
          <div id="output" class="text-center">Kết quả sẽ hiển thị ở đây...</div>
          <h2 class="mt-4" style="font-size: 1.2em;">Cập nhật mới nhất</h2>
          <table class="table table-bordered">
            <thead><tr><th>Mã vải</th><th>Số cây</th><th>Số mét</th></tr></thead>
            <tbody id="latest-inventory"></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="inventory">
          <div class="filter-section">
            <h5>Lọc tồn kho</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="filterFabricType" class="form-label">Loại vải:</label>
                <select class="form-select" id="filterFabricType">
                  <option value="">Tất cả loại vải</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="filterColor" class="form-label">Màu:</label>
                <select class="form-select" id="filterColor">
                  <option value="">Tất cả màu</option>
                </select>
              </div>
              <div class="col-md-3 col-12 d-flex align-items-end">
                <button class="btn btn-primary" id="applyInventoryFilterButton">Thực hiện</button>
              </div>
            </div>
          </div>
          <h2 class="mt-2" style="font-size: 1.2em;">Tồn kho</h2>
          <div class="table-container">
            <table class="table table-bordered">
              <thead><tr><th>Mã vải</th><th>Số cây</th><th>Số mét</th><th>Hành động</th></tr></thead>
              <tbody id="inventory-table"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td>Tổng cộng</td>
                  <td id="total-trees"></td>
                  <td id="total-meters"></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="history">
          <div class="filter-section">
            <h5>Lọc giao dịch</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="filterCode" class="form-label">Mã vải:</label>
                <select class="form-select" id="filterCode">
                  <option value="">Tất cả mã</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="filterStartDate" class="form-label">Từ ngày:</label>
                <input type="date" class="form-control" id="filterStartDate">
              </div>
              <div class="col-md-3 col-12">
                <label for="filterEndDate" class="form-label">Đến ngày:</label>
                <input type="date" class="form-control" id="filterEndDate">
              </div>
              <div class="col-md-3 col-12 d-flex align-items-end">
                <button class="btn btn-primary" id="applyFilterButton">Thực hiện</button>
              </div>
            </div>
          </div>
          <h2 class="mt-2" style="font-size: 1.2em;">Lịch sử giao dịch</h2>
          <div class="table-container">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Ngày</th>
                  <th>Loại</th>
                  <th>Mã vải</th>
                  <th>Số cây</th>
                  <th>Số mét</th>
                  <th>Tồn kho (cây)</th>
                  <th>Tồn kho (mét)</th>
                  <th>Hành động</th>
                </tr>
              </thead>
              <tbody id="transactions"></tbody>
            </table>
          </div>
          <div class="pagination-section">
            <button class="btn btn-outline-primary pagination-btn" id="prevPageButton" disabled>Trước</button>
            <span id="pageInfo">Trang 1/1</span>
            <button class="btn btn-outline-primary pagination-btn" id="nextPageButton" disabled>Sau</button>
          </div>
        </div>
        <div class="tab-pane fade" id="manage">
          <div class="manage-section">
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <button class="btn btn-success w-100" id="exportInventoryButton">Xuất dữ liệu tồn kho</button>
              </div>
              <div class="col-md-3 col-12">
                <div class="file-input-wrapper">
                  <input type="file" class="form-control" id="importInventoryFile" accept=".xlsx,.csv">
                </div>
                <button class="btn btn-primary w-100 mt-2" id="importInventoryButton" disabled>Nhập dữ liệu tồn kho</button>
              </div>
              <div class="col-md-3 col-12">
                <button class="btn btn-danger w-100" id="deleteAllTransactionsButton">Xóa lịch sử giao dịch</button>
              </div>
              <div class="col-md-3 col-12">
                <button class="btn btn-success w-100" id="exportTransactionsButton">Xuất lịch sử giao dịch</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="confirmationModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xác nhận</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmationMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="confirmButton">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    class InventoryManager {
      constructor() {
        this.inventory = [];
        this.transactions = [];
        this.today = new Date().toISOString().split('T')[0];
        this.currentFilter = { code: '', startDate: '', endDate: '' };
        this.filterInventory = { fabricType: '', color: '' };
        this.currentPage = 1;
        this.itemsPerPage = 10;
        this.latestCode = null;
        this.editingIndex = null;
      }

      validateTransaction(code, trees, meters) {
        if (!/^\w{6}$/.test(code)) return 'Mã vải phải có đúng 6 ký tự!';
        if (isNaN(trees) || trees < 0 || isNaN(meters) || meters < 0) return 'Số cây và số mét phải hợp lệ!';
        if (trees === 0 && meters !== 0) return 'Nếu số cây là 0, số mét phải là 0!';
        const decimalPart = meters.toString().split('.')[1];
        if (decimalPart && decimalPart.length > 1) return 'Số mét chỉ được có 1 chữ số thập phân!';
        return null;
      }

      parseDate(dateStr) {
        if (!dateStr) return null;
        let date;
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          const [year, month, day] = dateStr.split('-').map(Number);
          date = new Date(year, month - 1, day);
          console.log('Parsed YYYY-MM-DD:', dateStr, '->', date);
        } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
          const [day, month, year] = dateStr.split('/').map(Number);
          date = new Date(year, month - 1, day);
          console.log('Parsed DD/MM/YYYY:', dateStr, '->', date);
        } else {
          console.warn('Invalid date format:', dateStr);
          return null;
        }
        if (isNaN(date)) {
          console.warn('Invalid date:', dateStr);
          return null;
        }
        return date;
      }

      formatDate(dateStr) {
        const date = this.parseDate(dateStr);
        if (!date) {
          console.warn('Cannot format invalid date:', dateStr);
          return '';
        }
        const formatted = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        console.log('Formatted date:', dateStr, '->', formatted);
        return formatted;
      }

      cleanZeroLines() {
        this.inventory = this.inventory.filter(line => {
          if (line.trees === 0 && line.meters === 0) {
            const otherLines = this.inventory.filter(l => l.code === line.code && (l.trees > 0 || l.meters > 0));
            return otherLines.length === 0;
          }
          return true;
        });
        console.log('Cleaned zero lines, current inventory:', this.inventory);
      }

      sortTransactions() {
        this.transactions.sort((a, b) => this.parseDate(b.date) - this.parseDate(a.date));
        console.log('Sorted transactions:', this.transactions);
      }

      rebuildInventory() {
        const transactions = [...this.transactions];
        this.inventory = [];
        this.transactions = [];
        transactions.sort((a, b) => this.parseDate(a.date) - this.parseDate(b.date));
        for (const t of transactions) {
          this.addTransaction(t.type, t.code.replace('-', ''), t.trees, t.meters, t.date, true);
        }
        this.sortTransactions();
        console.log('Rebuilt inventory:', this.inventory);
      }

      addTransaction(type, code, trees, meters, date, skipRebuild = false) {
        console.log('Adding transaction:', { type, code, trees, meters, date });
        const formattedCode = code.slice(0, 3) + '-' + code.slice(3);
        const formattedMeters = parseFloat(meters.toFixed(1));
        const formattedDate = this.formatDate(date);
        if (!formattedDate) return { success: false, error: 'Ngày không hợp lệ!' };

        if (type === 'n') {
          const newLine = { code: formattedCode, trees, meters: formattedMeters, date: formattedDate };
          this.inventory.push(newLine);
        } else {
          let remainingTrees = trees;
          let remainingMeters = formattedMeters;
          const stockLines = this.inventory.filter(line => line.code === formattedCode && line.trees > 0);
          stockLines.sort((a, b) => this.parseDate(a.date) - this.parseDate(b.date));

          let totalStockTrees = stockLines.reduce((sum, line) => sum + line.trees, 0);
          let totalStockMeters = stockLines.reduce((sum, line) => sum + line.meters, 0);
          if (totalStockTrees < trees || totalStockMeters < meters) {
            return { success: false, error: `Không đủ tồn kho mã ${formattedCode}. Tồn kho: ${totalStockTrees} cây, ${totalStockMeters.toFixed(1)} mét.` };
          }

          for (let line of stockLines) {
            if (remainingTrees <= 0 && remainingMeters <= 0) break;
            if (line.trees <= 0) continue;

            const treesToTake = Math.min(line.trees, remainingTrees);
            const metersPerTree = line.meters / line.trees;
            const metersToTake = treesToTake * metersPerTree;

            if (metersToTake <= remainingMeters) {
              line.trees -= treesToTake;
              line.meters -= metersToTake;
              remainingTrees -= treesToTake;
              remainingMeters -= metersToTake;
            }
          }

          if (remainingTrees > 0 || remainingMeters > 0) {
            return { success: false, error: `Không thể xuất mã ${formattedCode} với số cây/mét yêu cầu.` };
          }
        }

        if (!skipRebuild) {
          this.cleanZeroLines();
        }

        const stockLines = this.inventory.filter(line => line.code === formattedCode);
        const stockTrees = stockLines.reduce((sum, line) => sum + line.trees, 0);
        const stockMeters = stockLines.reduce((sum, line) => sum + line.meters, 0);

        const transaction = {
          date: formattedDate,
          type,
          displayType: type === 'n' ? 'nhập' : 'xuất',
          code: formattedCode,
          trees,
          meters: formattedMeters,
          stockTrees,
          stockMeters
        };

        this.transactions.push(transaction);
        this.sortTransactions();
        this.latestCode = formattedCode;
        console.log('Added transaction:', transaction);
        console.log('Current inventory:', this.inventory);
        console.log('Current transactions:', this.transactions);
        console.log('Latest code:', this.latestCode);
        return { success: true, transaction, formattedCode };
      }

      editTransaction(index, type, code, trees, meters, date) {
        console.log('Editing transaction:', { index, type, code, trees, meters, date });
        const oldTransaction = this.transactions[index];
        if (!oldTransaction) {
          return { success: false, error: 'Giao dịch không tồn tại!' };
        }

        this.transactions.splice(index, 1);
        this.rebuildInventory();

        const result = this.addTransaction(type, code, trees, meters, date);
        if (!result.success) {
          this.transactions.splice(index, 0, oldTransaction);
          this.rebuildInventory();
          return result;
        }

        return { success: true };
      }

      deleteTransaction(index) {
        console.log('Deleting transaction at index:', index);
        const transaction = this.transactions[index];
        if (!transaction) {
          return { success: false, error: 'Giao dịch không tồn tại!' };
        }

        this.transactions.splice(index, 1);
        this.rebuildInventory();
        return { success: true };
      }

      deleteAllTransactions() {
        console.log('Deleting all transactions');
        this.transactions = [];
        this.inventory = [];
        this.latestCode = null;
        console.log('All transactions deleted, inventory cleared');
        return { success: true };
      }

      downloadCSV(csvContent, fileName) {
        try {
          const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = fileName;
          link.click();
          URL.revokeObjectURL(link.href);
          console.log('Downloaded CSV:', fileName);
          return { success: true, fileName };
        } catch (error) {
          console.error('Error downloading CSV:', error);
          return { success: false, error: 'Lỗi tải file CSV!' };
        }
      }

      exportInventoryToCSV() {
        console.log('Exporting inventory to CSV');
        const today = this.formatDate(this.today);
        const data = this.inventory.map(line => ({
          'Ngày': today,
          'Loại': 'Nhập',
          'Mã vải': line.code,
          'Số cây': line.trees,
          'Số mét': line.meters.toFixed(1)
        }));

        if (data.length === 0) {
          return { success: false, error: 'Không có dữ liệu tồn kho để xuất!' };
        }

        const headers = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'];
        const csvRows = [
          headers.join(','),
          ...data.map(row => [
            `"${row['Ngày']}"`,
            `"${row['Loại']}"`,
            `"${row['Mã vải']}"`,
            row['Số cây'],
            row['Số mét']
          ].join(','))
        ];
        const csvContent = csvRows.join('\n');
        const fileName = `TonKho_${this.today.replace(/-/g, '')}.csv`;

        return this.downloadCSV(csvContent, fileName);
      }

      exportTransactionsToCSV() {
        console.log('Exporting transactions to CSV');
        const data = this.transactions.map(t => ({
          'Ngày': t.date,
          'Loại': t.displayType,
          'Mã vải': t.code,
          'Số cây': t.trees,
          'Số mét': t.meters.toFixed(1),
          'Tồn kho (cây)': t.stockTrees,
          'Tồn kho (mét)': t.stockMeters.toFixed(1)
        }));

        if (data.length === 0) {
          return { success: false, error: 'Không có lịch sử giao dịch để xuất!' };
        }

        const headers = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét', 'Tồn kho (cây)', 'Tồn kho (mét)'];
        const csvRows = [
          headers.join(','),
          ...data.map(row => [
            `"${row['Ngày']}"`,
            `"${row['Loại']}"`,
            `"${row['Mã vải']}"`,
            row['Số cây'],
            row['Số mét'],
            row['Tồn kho (cây)'],
            row['Tồn kho (mét)']
          ].join(','))
        ];
        const csvContent = csvRows.join('\n');
        const fileName = `LichSuGiaoDich_${this.today.replace(/-/g, '')}.csv`;

        return this.downloadCSV(csvContent, fileName);
      }

      parseCSV(csvText) {
        console.log('Parsing CSV content');
        const lines = csvText.replace(/^\uFEFF/, '').split('\n').filter(line => line.trim());
        if (lines.length === 0) {
          return { success: false, error: 'File CSV rỗng!' };
        }

        const parseCSVLine = (line) => {
          const values = [];
          let current = '';
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          return values;
        };

        const headers = parseCSVLine(lines[0]).map(h => h.trim());
        const expectedHeader = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'];
        if (!expectedHeader.every((col, i) => headers[i] === col)) {
          return { success: false, error: 'File CSV không đúng định dạng! Header phải là: ' + expectedHeader.join(',') };
        }

        const dataRows = lines.slice(1).map((line, index) => {
          const values = parseCSVLine(line);
          if (values.length !== headers.length) {
            return { error: `Dòng ${index + 2} không đủ cột: ${line}` };
          }
          return {
            'Ngày': values[0].replace(/^"|"$/g, ''),
            'Loại': values[1].replace(/^"|"$/g, ''),
            'Mã vải': values[2].replace(/^"|"$/g, ''),
            'Số cây': values[3],
            'Số mét': values[4]
          };
        });

        const errors = dataRows.filter(row => row.error).map(row => row.error);
        if (errors.length > 0) {
          return { success: false, error: `Lỗi cú pháp CSV:\n${errors.join('\n')}` };
        }

        return { success: true, data: dataRows };
      }

      importInventory(file) {
        console.log('Importing inventory from file:', file.name);
        return new Promise((resolve) => {
          const fileExtension = file.name.split('.').pop().toLowerCase();
          const reader = new FileReader();

          if (fileExtension === 'csv') {
            reader.onload = (e) => {
              try {
                const csvText = e.target.result;
                const csvResult = this.parseCSV(csvText);
                if (!csvResult.success) {
                  resolve({ success: false, error: csvResult.error });
                  return;
                }

                const dataRows = csvResult.data;
                if (dataRows.length === 0) {
                  resolve({ success: false, error: 'File CSV không chứa dữ liệu!' });
                  return;
                }

                const errors = [];
                for (let i = 0; i < dataRows.length; i++) {
                  const row = dataRows[i];
                  const { 'Ngày': date, 'Loại': type, 'Mã vải': code, 'Số cây': trees, 'Số mét': meters } = row;

                  if (!date || type !== 'Nhập' || !code || !trees || !meters) {
                    errors.push(`Dòng ${i + 2} không hợp lệ: ${JSON.stringify(row)}`);
                    continue;
                  }

                  const cleanCode = code.replace('-', '');
                  const parsedTrees = parseInt(trees);
                  const parsedMeters = parseFloat(meters);

                  if (isNaN(parsedTrees) || isNaN(parsedMeters)) {
                    errors.push(`Dòng ${i + 2}, mã ${code}: Số cây hoặc số mét không hợp lệ!`);
                    continue;
                  }

                  const error = this.validateTransaction(cleanCode, parsedTrees, parsedMeters);
                  if (error) {
                    errors.push(`Lỗi tại dòng ${i + 2}, mã ${code}: ${error}`);
                    continue;
                  }

                  const result = this.addTransaction('n', cleanCode, parsedTrees, parsedMeters, date);
                  if (!result.success) {
                    errors.push(`Lỗi thêm giao dịch tại dòng ${i + 2}, mã ${code}: ${result.error}`);
                  }
                }

                if (errors.length > 0) {
                  resolve({ success: false, error: `Có lỗi khi nhập dữ liệu:\n${errors.join('\n')}` });
                } else {
                  resolve({ success: true });
                }
              } catch (error) {
                console.error('Error reading CSV file:', error);
                resolve({ success: false, error: 'Lỗi đọc file CSV!' });
              }
            };
            reader.readAsText(file, 'UTF-8');
          } else if (fileExtension === 'xlsx') {
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'], defval: '' });

                console.log('Parsed Excel data:', json);

                if (json.length === 0) {
                  resolve({ success: false, error: 'File Excel rỗng!' });
                  return;
                }

                const expectedHeader = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'];
                const firstRow = json[0];
                const isHeader = expectedHeader.every((col, i) => firstRow[col] === col);
                const dataRows = isHeader ? json.slice(1) : json;

                if (dataRows.length === 0) {
                  resolve({ success: false, error: 'File Excel không chứa dữ liệu hợp lệ!' });
                  return;
                }

                const errors = [];
                for (let i = 0; i < dataRows.length; i++) {
                  const row = dataRows[i];
                  const { 'Ngày': date, 'Loại': type, 'Mã vải': code, 'Số cây': trees, 'Số mét': meters } = row;
                  if (!date || type !== 'Nhập' || !code || isNaN(trees) || isNaN(meters)) {
                    errors.push(`Dòng ${i + (isHeader ? 2 : 1)} không hợp lệ: ${JSON.stringify(row)}`);
                    continue;
                  }
                  const cleanCode = code.replace('-', '');
                  const error = this.validateTransaction(cleanCode, parseInt(trees), parseFloat(meters));
                  if (error) {
                    errors.push(`Lỗi tại dòng ${i + (isHeader ? 2 : 1)}, mã ${code}: ${error}`);
                    continue;
                  }
                  const result = this.addTransaction('n', cleanCode, parseInt(trees), parseFloat(meters), date);
                  if (!result.success) {
                    errors.push(`Lỗi thêm giao dịch tại dòng ${i + (isHeader ? 2 : 1)}, mã ${code}: ${result.error}`);
                  }
                }

                if (errors.length > 0) {
                  resolve({ success: false, error: `Có lỗi khi nhập dữ liệu:\n${errors.join('\n')}` });
                } else {
                  resolve({ success: true });
                }
              } catch (error) {
                console.error('Error reading Excel file:', error);
                resolve({ success: false, error: 'Lỗi đọc file Excel!' });
              }
            };
            reader.readAsArrayBuffer(file);
          } else {
            resolve({ success: false, error: 'Định dạng file không hỗ trợ! Vui lòng chọn file .xlsx hoặc .csv.' });
          }
        });
      }

      getFilteredTransactions() {
        const filtered = this.transactions.filter(t => {
          const date = this.parseDate(t.date);
          if (!date || !t.code) {
            console.warn('Invalid transaction filtered out:', t);
            return false;
          }
          const startDate = this.currentFilter.startDate ? this.parseDate(this.currentFilter.startDate) : null;
          const endDate = this.currentFilter.endDate ? this.parseDate(this.currentFilter.endDate) : null;
          return (
            (!this.currentFilter.code || t.code === this.currentFilter.code) &&
            (!startDate || date >= startDate) &&
            (!endDate || date <= endDate)
          );
        });
        console.log('Filtered transactions:', filtered);
        return filtered;
      }

      getFilteredInventory() {
        const filtered = this.inventory.filter(line => {
          const fabricType = line.code.split('-')[0];
          const color = line.code.split('-')[1];
          return (
            (!this.filterInventory.fabricType || fabricType === this.filterInventory.fabricType) &&
            (!this.filterInventory.color || color === this.filterInventory.color)
          );
        });
        filtered.sort((a, b) => a.code.localeCompare(b.code));
        console.log('Filtered inventory:', filtered);
        return filtered;
      }

      getFabricTypes() {
        const fabricTypes = [...new Set(this.inventory.map(line => line.code.split('-')[0]))].sort();
        console.log('Fabric types:', fabricTypes);
        return fabricTypes;
      }

      getColors() {
        const colors = [...new Set(this.inventory.map(line => line.code.split('-')[1]))].sort();
        console.log('Colors:', colors);
        return colors;
      }

      saveData() {
        try {
          localStorage.setItem('inventory', JSON.stringify(this.inventory));
          localStorage.setItem('transactions', JSON.stringify(this.transactions));
          console.log('Saved data:', { inventory: this.inventory, transactions: this.transactions });
          return true;
        } catch (error) {
          console.error('Lỗi lưu dữ liệu:', error);
          return false;
        }
      }

      loadData() {
        try {
          this.inventory = JSON.parse(localStorage.getItem('inventory') || '[]')
            .filter(line => line.code && line.trees >= 0 && line.meters >= 0 && line.date);
          this.transactions = JSON.parse(localStorage.getItem('transactions') || '[]')
            .filter(t => {
              const valid = t.date && t.code && this.parseDate(t.date) && t.type && t.trees >= 0 && t.meters >= 0;
              if (!valid) console.warn('Invalid transaction filtered out during load:', t);
              return valid;
            });
          this.sortTransactions();
          if (this.transactions.length > 0) {
            this.latestCode = this.transactions[0].code;
          }
          this.cleanZeroLines();
          console.log('Loaded data:', { inventory: this.inventory, transactions: this.transactions });
        } catch (error) {
          console.error('Lỗi tải dữ liệu:', error);
        }
      }
    }

    const inventoryManager = new InventoryManager();
    const showOutput = (msg) => {
      const output = document.getElementById('output');
      if (output) output.textContent = msg;
      console.log('Output:', msg);
    };

    const showConfirmation = (message, callback) => {
      const confirmationMessage = document.getElementById('confirmationMessage');
      if (!confirmationMessage) {
        console.error('Confirmation message element not found');
        showOutput('Lỗi hiển thị modal xác nhận!');
        return;
      }
      confirmationMessage.textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      modal.show();
      const confirmButton = document.getElementById('confirmButton');
      const newButton = confirmButton.cloneNode(true);
      confirmButton.parentNode.replaceChild(newButton, confirmButton);
      newButton.addEventListener('click', () => {
        console.log('Confirmation button clicked');
        callback();
        modal.hide();
      });
    };

    const updateLatestInventory = () => {
      const latestInventoryBody = document.getElementById('latest-inventory');
      if (!latestInventoryBody) {
        console.error('Element latest-inventory not found');
        showOutput('Lỗi hiển thị cập nhật mới nhất!');
        return;
      }
      console.log('Updating latest inventory:', { latestCode: inventoryManager.latestCode });
      if (!inventoryManager.latestCode) {
        latestInventoryBody.innerHTML = '<tr><td colspan="3" class="text-center">Chưa có giao dịch</td></tr>';
        return;
      }
      const stockLines = inventoryManager.inventory.filter(line => line.code === inventoryManager.latestCode);
      const totalTrees = stockLines.reduce((sum, line) => sum + line.trees, 0);
      const totalMeters = stockLines.reduce((sum, line) => sum + line.meters, 0);
      latestInventoryBody.innerHTML = `
        <tr>
          <td>${inventoryManager.latestCode}</td>
          <td>${totalTrees}</td>
          <td>${totalMeters.toFixed(1)} m</td>
        </tr>`;
    };

    const updateInventoryTable = () => {
      const inventoryTableBody = document.getElementById('inventory-table');
      const totalTreesCell = document.getElementById('total-trees');
      const totalMetersCell = document.getElementById('total-meters');
      if (!inventoryTableBody || !totalTreesCell || !totalMetersCell) {
        console.error('Inventory table elements not found');
        showOutput('Lỗi hiển thị bảng tồn kho!');
        return;
      }
      const filteredInventory = inventoryManager.getFilteredInventory();
      let totalTrees = 0;
      let totalMeters = 0;
      filteredInventory.forEach(line => {
        totalTrees += line.trees;
        totalMeters += line.meters;
      });

      console.log('Updating inventory table:', { inventoryCount: filteredInventory.length, totalTrees, totalMeters });
      inventoryTableBody.innerHTML = filteredInventory.length === 0
        ? '<tr><td colspan="4" class="text-center">Chưa có tồn kho</td></tr>'
        : filteredInventory.map(line => `
            <tr>
              <td>${line.code}</td>
              <td>${line.trees}</td>
              <td>${line.meters.toFixed(1)} m</td>
              <td>
                <button class="btn btn-warning btn-sm action-btn" onclick='transferToInputTab(${JSON.stringify(line)})' ${line.trees === 0 && line.meters === 0 ? 'disabled' : ''}>Xuất</button>
              </td>
            </tr>`).join('');

      totalTreesCell.textContent = totalTrees;
      totalMetersCell.textContent = `${totalMeters.toFixed(1)} m`;
    };

    const updateInventoryFilters = () => {
      const fabricTypeSelect = document.getElementById('filterFabricType');
      const colorSelect = document.getElementById('filterColor');
      if (!fabricTypeSelect || !colorSelect) {
        console.error('Inventory filter elements not found');
        return;
      }
      const fabricTypes = inventoryManager.getFabricTypes();
      const colors = inventoryManager.getColors();
      fabricTypeSelect.innerHTML = '<option value="">Tất cả loại vải</option>' +
        fabricTypes.map(type => `<option value="${type}">${type}</option>`).join('');
      colorSelect.innerHTML = '<option value="">Tất cả màu</option>' +
        colors.map(color => `<option value="${color}">${color}</option>`).join('');
      console.log('Updated inventory filters:', { fabricTypes, colors });
    };

    const updateHistoryTable = () => {
      const transactionsBody = document.getElementById('transactions');
      if (!transactionsBody) {
        console.error('Element transactions not found');
        showOutput('Lỗi hiển thị lịch sử giao dịch!');
        return;
      }
      const filteredTransactions = inventoryManager.getFilteredTransactions();
      const totalPages = Math.max(1, Math.ceil(filteredTransactions.length / inventoryManager.itemsPerPage));
      inventoryManager.currentPage = Math.min(inventoryManager.currentPage, totalPages);
      const start = (inventoryManager.currentPage - 1) * inventoryManager.itemsPerPage;
      const pageTransactions = filteredTransactions.slice(start, start + inventoryManager.itemsPerPage);
      console.log('Updating history table:', { transactions: inventoryManager.transactions.length, filteredTransactions: filteredTransactions.length, pageTransactions: pageTransactions.length });
      transactionsBody.innerHTML = pageTransactions.length === 0
        ? '<tr><td colspan="8" class="text-center">Không có giao dịch</td></tr>'
        : pageTransactions.map((t, index) => {
            const globalIndex = start + index;
            return `
              <tr>
                <td>${t.date}</td>
                <td>${t.displayType}</td>
                <td>${t.code}</td>
                <td>${t.trees}</td>
                <td>${t.meters.toFixed(1)} m</td>
                <td>${t.stockTrees}</td>
                <td>${t.stockMeters.toFixed(1)} m</td>
                <td>
                  <button class="btn btn-warning btn-sm action-btn" onclick="editTransaction(${globalIndex})">Sửa</button>
                  <button class="btn btn-danger btn-sm action-btn" onclick="deleteTransaction(${globalIndex})">Xóa</button>
                </td>
              </tr>`;
          }).join('');
      const pageInfo = document.getElementById('pageInfo');
      if (pageInfo) pageInfo.textContent = `Trang ${inventoryManager.currentPage}/${totalPages}`;
      const prevButton = document.getElementById('prevPageButton');
      const nextButton = document.getElementById('nextPageButton');
      if (prevButton) prevButton.disabled = inventoryManager.currentPage === 1;
      if (nextButton) nextButton.disabled = inventoryManager.currentPage === totalPages;
    };

    const updateFilterDropdown = () => {
      const filterSelect = document.getElementById('filterCode');
      if (!filterSelect) {
        console.error('Filter code select not found');
        return;
      }
      const codes = [...new Set(inventoryManager.transactions.map(t => t.code))].sort();
      filterSelect.innerHTML = '<option value="">Tất cả mã</option>' + codes.map(code => `<option value="${code}">${code}</option>`).join('');
      console.log('Updated filter dropdown:', codes);
    };

    const updateUI = () => {
      console.log('Updating UI');
      updateLatestInventory();
      updateInventoryTable();
      updateInventoryFilters();
      updateHistoryTable();
      updateFilterDropdown();
    };

    const processFormCommand = () => {
      const type = document.getElementById('formType')?.value;
      const code = document.getElementById('formCode')?.value.trim().toUpperCase();
      const trees = parseInt(document.getElementById('formTrees')?.value);
      const meters = parseFloat(document.getElementById('formMeters')?.value);
      const date = document.getElementById('formDate')?.value || inventoryManager.today;

      console.log('Processing form:', { type, code, trees, meters, date, editingIndex: inventoryManager.editingIndex });

      if (!type || !code || isNaN(trees) || isNaN(meters)) {
        showOutput('Vui lòng nhập đầy đủ thông tin!');
        return;
      }

      const error = inventoryManager.validateTransaction(code, trees, meters);
      if (error) {
        showOutput(error);
        return;
      }

      const formattedCode = code.slice(0, 3) + '-' + code.slice(3);
      const formattedMeters = parseFloat(meters.toFixed(1));
      const formattedDate = inventoryManager.formatDate(date);

      const message = inventoryManager.editingIndex !== null
        ? `Xác nhận cập nhật giao dịch mã ${formattedCode} với ${type === 'n' ? 'nhập' : 'xuất'} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}?`
        : `Xác nhận ${type === 'n' ? 'nhập' : 'xuất'} mã ${formattedCode} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}?`;

      showConfirmation(message, () => {
        console.log('Confirmed transaction');
        let result;
        if (inventoryManager.editingIndex !== null) {
          result = inventoryManager.editTransaction(inventoryManager.editingIndex, type, code, trees, meters, date);
          inventoryManager.editingIndex = null;
        } else {
          result = inventoryManager.addTransaction(type, code, trees, meters, date);
        }

        if (!result.success) {
          showOutput(result.error);
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã cập nhật thành công!');
        document.getElementById('formCode').value = '';
        document.getElementById('formTrees').value = '0';
        document.getElementById('formMeters').value = '0.0';
      });
    };

    const editTransaction = (index) => {
      const transaction = inventoryManager.transactions[index];
      if (!transaction) {
        console.error('Invalid transaction index:', index);
        showOutput('Lỗi truy cập giao dịch!');
        return;
      }
      const inputTab = document.getElementById('input-tab');
      if (!inputTab) {
        console.error('Input tab not found');
        showOutput('Lỗi chuyển tab nhập liệu!');
        return;
      }
      const formType = document.getElementById('formType');
      const formCode = document.getElementById('formCode');
      const formTrees = document.getElementById('formTrees');
      const formMeters = document.getElementById('formMeters');
      const formDate = document.getElementById('formDate');
      if (!formType || !formCode || !formTrees || !formMeters || !formDate) {
        console.error('Form elements not found');
        showOutput('Lỗi điền form nhập liệu!');
        return;
      }

      inventoryManager.editingIndex = index;
      formType.value = transaction.type;
      formCode.value = transaction.code.replace('-', '');
      formTrees.value = transaction.trees;
      formMeters.value = transaction.meters.toFixed(1);
      formDate.value = transaction.date.split('/').reverse().join('-');

      const tab = new bootstrap.Tab(inputTab);
      tab.show();
      console.log('Editing transaction:', { index, transaction });
    };

    const deleteTransaction = (index) => {
      const transaction = inventoryManager.transactions[index];
      if (!transaction) {
        console.error('Invalid transaction index:', index);
        showOutput('Lỗi truy cập giao dịch!');
        return;
      }

      showConfirmation(`Bạn có chắc chắn muốn xóa giao dịch ${transaction.displayType} mã ${transaction.code} ngày ${transaction.date}?`, () => {
        const result = inventoryManager.deleteTransaction(index);
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã xóa giao dịch thành công!');
      });
    };

    const exportInventory = () => {
      showConfirmation('Xác nhận xuất dữ liệu tồn kho ra file CSV?', () => {
        const result = inventoryManager.exportInventoryToCSV();
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        showOutput(`Đã xuất dữ liệu thành công: ${result.fileName}`);
      });
    };

    const exportTransactions = () => {
      showConfirmation('Xác nhận xuất lịch sử giao dịch ra file CSV?', () => {
        const result = inventoryManager.exportTransactionsToCSV();
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        showOutput(`Đã xuất dữ liệu thành công: ${result.fileName}`);
      });
    };

    const importInventory = async () => {
      const fileInput = document.getElementById('importInventoryFile');
      if (!fileInput || !fileInput.files[0]) {
        showOutput('Vui lòng chọn file!');
        return;
      }
      const file = fileInput.files[0];
      showConfirmation('Xác nhận nhập dữ liệu tồn kho từ file đã chọn?', async () => {
        const result = await inventoryManager.importInventory(file);
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã nhập dữ liệu thành công!');
        fileInput.value = '';
        document.getElementById('importInventoryButton').disabled = true;
      });
    };

    const deleteAllTransactions = () => {
      showConfirmation('Xác nhận xóa toàn bộ lịch sử giao dịch? Hành động này không thể hoàn tác.', () => {
        const result = inventoryManager.deleteAllTransactions();
        if (!result.success) {
          showOutput('Lỗi xóa lịch sử giao dịch!');
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã xóa toàn bộ lịch sử giao dịch!');
      });
    };

    const applyFilter = () => {
      const filterCode = document.getElementById('filterCode')?.value;
      const filterStartDate = document.getElementById('filterStartDate')?.value;
      const filterEndDate = document.getElementById('filterEndDate')?.value;
      inventoryManager.currentFilter = {
        code: filterCode || '',
        startDate: filterStartDate || '',
        endDate: filterEndDate || ''
      };
      inventoryManager.currentPage = 1;
      console.log('Applying filter:', inventoryManager.currentFilter);
      updateUI();
    };

    const applyInventoryFilter = () => {
      const filterFabricType = document.getElementById('filterFabricType')?.value;
      const filterColor = document.getElementById('filterColor')?.value;
      inventoryManager.filterInventory = {
        fabricType: filterFabricType || '',
        color: filterColor || ''
      };
      console.log('Applying inventory filter:', inventoryManager.filterInventory);
      updateUI();
    };

    const prevPage = () => {
      if (inventoryManager.currentPage > 1) {
        inventoryManager.currentPage--;
        updateUI();
      }
    };

    const nextPage = () => {
      const filteredTransactions = inventoryManager.getFilteredTransactions();
      const totalPages = Math.max(1, Math.ceil(filteredTransactions.length / inventoryManager.itemsPerPage));
      if (inventoryManager.currentPage < totalPages) {
        inventoryManager.currentPage++;
        updateUI();
      }
    };

    const transferToInputTab = (line) => {
      if (!line || !line.code) {
        console.error('Invalid inventory line:', line);
        showOutput('Lỗi truy cập dòng tồn kho!');
        return;
      }
      const inputTab = document.getElementById('input-tab');
      if (!inputTab) {
        console.error('Input tab not found');
        showOutput('Lỗi chuyển tab nhập liệu!');
        return;
      }
      const formType = document.getElementById('formType');
      const formCode = document.getElementById('formCode');
      const formTrees = document.getElementById('formTrees');
      const formMeters = document.getElementById('formMeters');
      const formDate = document.getElementById('formDate');
      if (!formType || !formCode || !formTrees || !formMeters || !formDate) {
        console.error('Form elements not found');
        showOutput('Lỗi điền form nhập liệu!');
        return;
      }

      formType.value = 'x';
      formCode.value = line.code.replace('-', '');
      formTrees.value = line.trees;
      formMeters.value = line.meters.toFixed(1);
      formDate.value = inventoryManager.today;

      const tab = new bootstrap.Tab(inputTab);
      tab.show();
      console.log('Transferred to input tab:', { code: line.code, trees: line.trees, meters: line.meters });
    };

    document.getElementById('formDate').value = inventoryManager.today;
    const inputTab = document.getElementById('input-tab');
    if (inputTab) {
      inputTab.addEventListener('shown.bs.tab', () => {
        const formCode = document.getElementById('formCode');
        if (formCode) formCode.focus();
      });
    }
    const processButton = document.getElementById('processFormButton');
    if (processButton) processButton.addEventListener('click', processFormCommand);
    const applyFilterButton = document.getElementById('applyFilterButton');
    if (applyFilterButton) applyFilterButton.addEventListener('click', applyFilter);
    const applyInventoryFilterButton = document.getElementById('applyInventoryFilterButton');
    if (applyInventoryFilterButton) applyInventoryFilterButton.addEventListener('click', applyInventoryFilter);
    const prevPageButton = document.getElementById('prevPageButton');
    if (prevPageButton) prevPageButton.addEventListener('click', prevPage);
    const nextPageButton = document.getElementById('nextPageButton');
    if (nextPageButton) nextPageButton.addEventListener('click', nextPage);
    const exportInventoryButton = document.getElementById('exportInventoryButton');
    if (exportInventoryButton) exportInventoryButton.addEventListener('click', exportInventory);
    const exportTransactionsButton = document.getElementById('exportTransactionsButton');
    if (exportTransactionsButton) exportTransactionsButton.addEventListener('click', exportTransactions);
    const importInventoryButton = document.getElementById('importInventoryButton');
    if (importInventoryButton) importInventoryButton.addEventListener('click', importInventory);
    const deleteAllTransactionsButton = document.getElementById('deleteAllTransactionsButton');
    if (deleteAllTransactionsButton) deleteAllTransactionsButton.addEventListener('click', deleteAllTransactions);
    const importInventoryFile = document.getElementById('importInventoryFile');
    if (importInventoryFile) {
      importInventoryFile.addEventListener('change', () => {
        const importButton = document.getElementById('importInventoryButton');
        if (importButton) importButton.disabled = !importInventoryFile.files[0];
      });
    }

    console.log('Initializing app');
    inventoryManager.loadData();
    updateUI();
  </script>
</body>
</html>
