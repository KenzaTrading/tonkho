<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý kho vải</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 15px; background-color: #f4f7fa; }
    .container { max-width: 800px; margin: auto; }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .nav-tabs { border-bottom: 2px solid #e0e7ff; }
    .nav-link { color: #495057; font-weight: 500; padding: 10px 20px; }
    .nav-link.active { background-color: #e0e7ff; color: #0d6efd; border-radius: 8px 8px 0 0; }
    .tab-content { padding: 20px; background: #fff; border-radius: 0 0 10px 10px; }
    #output { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px; font-size: 0.9em; }
    .table-container { max-height: 400px; overflow-y: auto; margin-top: 15px; }
    .table { font-size: 0.9em; }
    .table th, .table td { vertical-align: middle; }
    .table th:last-child, .table td:last-child { min-width: 80px; }
    .table .total-row { font-weight: bold; background-color: #f8f9fa; }
    .btn { border-radius: 5px; font-size: 0.9em; padding: 10px 20px; }
    .form-control, .form-select { font-size: 0.9em; border-radius: 5px; }
    .form-section, .filter-section { margin-bottom: 25px; }
    .action-btn { padding: 6px 12px; font-size: 0.85em; }
    .manage-data-btns { display: flex; gap: 10px; align-items: center; }
    @media (max-width: 576px) {
      body { padding: 10px; }
      .nav-link { padding: 8px 15px; font-size: 0.9em; }
      .tab-content { padding: 15px; }
      .btn { width: 100%; margin-bottom: 10px; padding: 12px; font-size: 1em; }
      .action-btn { padding: 8px 14px; font-size: 0.9em; }
      .form-section h5, .filter-section h5 { font-size: 1em; }
      .table { font-size: 0.8em; }
      .row.g-3 > div { margin-bottom: 10px; }
      .filter-section .col-12, .filter-section .col-md-6 { margin-bottom: 10px; }
      .manage-data-btns { flex-direction: column; align-items: stretch; }
      .form-section input[type="file"] { margin-bottom: 10px; }
      .form-section { margin-bottom: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4" style="font-size: 1.5em; color: #0d6efd;">Quản lý kho vải</h1>

    <div class="card">
      <!-- Nav tabs -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input" type="button" role="tab" aria-controls="input" aria-selected="true">Nhập liệu</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory-tab-content" type="button" role="tab" aria-controls="inventory-tab-content" aria-selected="false">Tồn kho</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">Lịch sử giao dịch</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab" aria-controls="manage" aria-selected="false">Quản lý dữ liệu</button>
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content" id="myTabContent">
        <!-- Tab 1: Nhập liệu -->
        <div class="tab-pane fade show active" id="input" role="tabpanel" aria-labelledby="input-tab">
          <!-- Form nhập liệu -->
          <div class="form-section">
            <h5>Nhập liệu</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="formType" class="form-label">Loại lệnh:</label>
                <select class="form-select" id="formType">
                  <option value="n">Nhập</option>
                  <option value="x">Xuất</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="formCode" class="form-label">Mã vải:</label>
                <input type="text" class="form-control" id="formCode" placeholder="VD: 950002">
              </div>
              <div class="col-md-2 col-12">
                <label for="formTrees" class="form-label">Số cây:</label>
                <input type="number" min="0" step="1" class="form-control" id="formTrees" value="0" placeholder="VD: 0">
              </div>
              <div class="col-md-2 col-12">
                <label for="formMeters" class="form-label">Số mét:</label>
                <input type="number" step="0.1" class="form-control" id="formMeters" value="0.0" placeholder="VD: 100.5">
              </div>
              <div class="col-md-2 col-12">
                <label for="formDate" class="form-label">Ngày:</label>
                <input type="date" class="form-control" id="formDate" value="">
              </div>
            </div>
            <button class="btn btn-primary mt-3" id="processFormButton">Thực hiện</button>
          </div>

          <div id="output" class="text-center">Kết quả sẽ hiển thị ở đây...</div>

          <h2 class="mt-4" style="font-size: 1.2em;">Cập nhật 5 mã gần nhất</h2>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Mã vải</th>
                <th>Số cây</th>
                <th>Số mét</th>
              </tr>
            </thead>
            <tbody id="recent-inventory"></tbody>
          </table>
        </div>

        <!-- Tab 2: Tồn kho -->
        <div class="tab-pane fade" id="inventory-tab-content" role="tabpanel" aria-labelledby="inventory-tab">
          <div class="filter-section">
            <h5>Lọc tồn kho</h5>
            <div class="row g-3">
              <div class="col-md-6 col-12">
                <label for="searchFabricType" class="form-label">Mã loại vải:</label>
                <select class="form-select" id="searchFabricType">
                  <option value="">Tất cả loại vải</option>
                </select>
              </div>
              <div class="col-md-6 col-12">
                <label for="searchColor" class="form-label">Mã màu:</label>
                <select class="form-select" id="searchColor">
                  <option value="">Tất cả màu</option>
                </select>
              </div>
              <div class="col-md-12 col-12 d-flex align-items-end">
                <button class="btn btn-primary" id="applyInventoryFilterButton">Thực hiện</button>
              </div>
            </div>
          </div>
          <h2 class="mt-2" style="font-size: 1.2em;">Tồn kho</h2>
          <div class="table-container">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Mã vải</th>
                  <th>Số cây</th>
                  <th>Số mét</th>
                  <th>Hành động</th>
                </tr>
              </thead>
              <tbody id="inventory"></tbody>
              <tfoot id="inventory-total" class="total-row"></tfoot>
            </table>
          </div>
        </div>

        <!-- Tab 3: Lịch sử giao dịch -->
        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
          <div class="filter-section">
            <h5>Lọc giao dịch</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="filterCode" class="form-label">Mã vải:</label>
                <select class="form-select" id="filterCode">
                  <option value="">Tất cả mã</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="filterStartDate" class="form-label">Từ ngày:</label>
                <input type="date" class="form-control" id="filterStartDate">
              </div>
              <div class="col-md-3 col-12">
                <label for="filterEndDate" class="form-label">Đến ngày:</label>
                <input type="date" class="form-control" id="filterEndDate">
              </div>
              <div class="col-md-3 col-12 d-flex align-items-end gap-2">
                <button class="btn btn-primary" id="applyFilterButton">Thực hiện</button>
                <button class="btn btn-secondary" id="clearHistoryFilterButton">Xóa bộ lọc</button>
              </div>
            </div>
          </div>
          <h2 class="mt-2" style="font-size: 1.2em;">Lịch sử giao dịch</h2>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Ngày</th>
                <th>Loại</th>
                <th>Mã vải</th>
                <th>Số cây</th>
                <th>Số mét</th>
                <th>Tồn kho (cây)</th>
                <th>Tồn kho (mét)</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="transactions"></tbody>
          </table>
          <div class="pagination-section">
            <button class="btn btn-outline-primary pagination-btn" id="prevPageButton" disabled>Trước</button>
            <span id="pageInfo">Trang 1/1</span>
            <button class="btn btn-outline-primary pagination-btn" id="nextPageButton" disabled>Sau</button>
          </div>
        </div>

        <!-- Tab 4: Quản lý dữ liệu -->
        <div class="tab-pane fade" id="manage" role="tabpanel" aria-labelledby="manage-tab">
          <div class="form-section">
            <h5>Xuất dữ liệu tồn kho</h5>
            <button class="btn btn-primary" id="exportInventoryButton">Thực hiện</button>
          </div>
          <div class="form-section">
            <h5>Nhập dữ liệu giao dịch</h5>
            <input type="file" class="form-control mb-2" id="importTransactions" accept=".csv">
            <button class="btn btn-primary" id="importTransactionsButton">Thực hiện</button>
          </div>
          <div class="form-section">
            <h5>Xuất dữ liệu giao dịch</h5>
            <button class="btn btn-primary" id="exportDataButton">Thực hiện</button>
          </div>
          <div class="form-section">
            <h5>Xóa toàn bộ dữ liệu</h5>
            <button class="btn btn-danger" id="clearAllButton">Thực hiện</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal xác nhận -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">Xác nhận lệnh</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmationMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="confirmButton">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal chỉnh sửa -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Chỉnh sửa giao dịch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editType" class="form-label">Loại lệnh:</label>
            <select class="form-select" id="editType">
              <option value="n">Nhập</option>
              <option value="x">Xuất</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editCode" class="form-label">Mã vải:</label>
            <input type="text" class="form-control" id="editCode" placeholder="VD: 950002">
          </div>
          <div class="mb-3">
            <label for="editTrees" class="form-label">Số cây:</label>
            <input type="number" min="0" step="1" class="form-control" id="editTrees" value="0">
          </div>
          <div class="mb-3">
            <label for="editMeters" class="form-label">Số mét:</label>
            <input type="number" step="0.1" class="form-control" id="editMeters" value="0.0">
          </div>
          <div class="mb-3">
            <label for="editDate" class="form-label">Ngày:</label>
            <input type="date" class="form-control" id="editDate">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="saveEditButton">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Dữ liệu kho
    let inventory = {};
    let transactions = [];
    let activeInputs = [];
    let inputIdCounter = 1;
    let pendingCommand = null;
    let editingIndex = null;
    let currentFilter = { code: '', startDate: '', endDate: '' };
    let currentPage = 1;
    const itemsPerPage = 10;

    // Thiết lập ngày mặc định là hôm nay
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('formDate').value = today;

    // Focus ô Mã vải khi mở tab Nhập liệu
    document.getElementById('input-tab').addEventListener('shown.bs.tab', function() {
      document.getElementById('formCode').focus();
    });

    // Hàm lưu dữ liệu vào localStorage
    function saveData() {
      try {
        localStorage.setItem('inventory', JSON.stringify(inventory));
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('activeInputs', JSON.stringify(activeInputs));
        localStorage.setItem('inputIdCounter', inputIdCounter);
      } catch (error) {
        console.error('Lỗi lưu localStorage:', error);
        document.getElementById('output').textContent = 'Lỗi lưu dữ liệu!';
      }
    }

    // Hàm tải dữ liệu từ localStorage
    function loadData() {
      try {
        inventory = JSON.parse(localStorage.getItem('inventory') || '{}');
        transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        activeInputs = JSON.parse(localStorage.getItem('activeInputs') || '[]');
        inputIdCounter = parseInt(localStorage.getItem('inputIdCounter') || '1');
        updateUI();
      } catch (error) {
        console.error('Lỗi tải localStorage:', error);
        document.getElementById('output').textContent = 'Lỗi tải dữ liệu!';
      }
    }

    // Hàm tính toán lại inventory từ activeInputs
    function recalculateInventory() {
      inventory = {};
      activeInputs.forEach(t => {
        if (t && t.code && t.trees >= 0 && t.meters >= 0) {
          inventory[t.code] = inventory[t.code] || { trees: 0, meters: 0 };
          inventory[t.code].trees += t.trees;
          inventory[t.code].meters += t.meters;
        }
      });
      transactions.forEach(t => {
        if (!inventory[t.code]) {
          inventory[t.code] = { trees: 0, meters: 0 };
        }
      });
    }

    // Hàm điền form lệnh Xuất từ Tab Tồn kho
    function fillExportForm(code, trees, meters) {
      console.log('fillExportForm called:', { code, trees, meters });
      const inputTab = new bootstrap.Tab(document.getElementById('input-tab'));
      inputTab.show();
      document.getElementById('formType').value = 'x';
      document.getElementById('formCode').value = code.replace('-', '');
      document.getElementById('formTrees').value = trees;
      document.getElementById('formMeters').value = meters.toFixed(1);
    }

    // Cập nhật giao diện
    function updateUI() {
      console.log('updateUI called');
      // Cập nhật 5 mã gần nhất
      const recentInventoryBody = document.getElementById('recent-inventory');
      recentInventoryBody.innerHTML = '';
      const codeLatestDates = {};
      transactions.forEach(t => {
        const date = new Date(t.date.split('/').reverse().join('-'));
        if (!codeLatestDates[t.code] || date > codeLatestDates[t.code].date) {
          codeLatestDates[t.code] = { date, code: t.code };
        }
      });
      const recentCodes = Object.values(codeLatestDates)
        .sort((a, b) => b.date - a.date)
        .slice(0, 5)
        .map(item => item.code);
      recentCodes.forEach(code => {
        const data = inventory[code] || { trees: 0, meters: 0 };
        recentInventoryBody.innerHTML += `<tr><td>${code}</td><td>${data.trees}</td><td>${data.meters.toFixed(1)} m</td></tr>`;
      });

      // Cập nhật tồn kho
      const inventoryBody = document.getElementById('inventory');
      const inventoryTotal = document.getElementById('inventory-total');
      inventoryBody.innerHTML = '';
      inventoryTotal.innerHTML = '';
      const fabricType = document.getElementById('searchFabricType').value;
      const color = document.getElementById('searchColor').value;
      let totalTrees = 0;
      let totalMeters = 0;
      const filteredCodes = Object.keys(inventory).filter(code => {
        return (
          (!fabricType || code.startsWith(fabricType + '-')) &&
          (!color || code.endsWith('-' + color))
        );
      });
      const pageCodes = filteredCodes;
      pageCodes.forEach(code => {
        const data = inventory[code];
        inventoryBody.innerHTML += `
          <tr>
            <td>${code}</td>
            <td>${data.trees}</td>
            <td>${data.meters.toFixed(1)} m</td>
            <td>
              <button class="btn btn-sm btn-primary action-btn export-btn" data-code="${code}" data-trees="${data.trees}" data-meters="${data.meters}" ${data.trees === 0 && data.meters === 0 ? 'disabled' : ''}>Xuất</button>
            </td>
          </tr>`;
        totalTrees += data.trees;
        totalMeters += data.meters;
      });
      if (pageCodes.length > 0) {
        inventoryTotal.innerHTML = `<tr class="total-row"><td>Tổng</td><td>${totalTrees}</td><td>${totalMeters.toFixed(1)} m</td><td></td></tr>`;
      }

      // Gắn sự kiện cho nút Xuất
      document.querySelectorAll('.export-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const code = btn.getAttribute('data-code');
          const trees = parseInt(btn.getAttribute('data-trees'));
          const meters = parseFloat(btn.getAttribute('data-meters'));
          fillExportForm(code, trees, meters);
        });
      });

      // Cập nhật dropdown tìm kiếm
      const fabricTypeSelect = document.getElementById('searchFabricType');
      const colorSelect = document.getElementById('searchColor');
      const filterSelect = document.getElementById('filterCode');
      const fabricTypes = [...new Set(Object.keys(inventory).map(code => code.split('-')[0]))].sort();
      const colors = [...new Set(Object.keys(inventory).map(code => code.split('-')[1]))].sort();
      const existingCodes = [...new Set(transactions.map(t => t.code))].sort();
      
      fabricTypeSelect.innerHTML = '<option value="">Tất cả loại vải</option>';
      fabricTypes.forEach(type => {
        fabricTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
      });
      
      colorSelect.innerHTML = '<option value="">Tất cả màu</option>';
      colors.forEach(color => {
        colorSelect.innerHTML += `<option value="${color}">${color}</option>`;
      });
      
      filterSelect.innerHTML = '<option value="">Tất cả mã</option>';
      existingCodes.forEach(code => {
        filterSelect.innerHTML += `<option value="${code}">${code}</option>`;
      });

      // Cập nhật lịch sử giao dịch
      const transactionsBody = document.getElementById('transactions');
      transactionsBody.innerHTML = '';
      const filteredTransactions = transactions.filter(t => {
        if (!t || !t.date || !t.code) return false;
        const [day, month, year] = t.date.split('/');
        const date = new Date(`${year}-${month}-${day}`);
        if (isNaN(date)) return false;
        const startDate = currentFilter.startDate ? new Date(currentFilter.startDate) : null;
        const endDate = currentFilter.endDate ? new Date(currentFilter.endDate) : null;
        return (
          (!currentFilter.code || t.code === currentFilter.code) &&
          (!startDate || date >= startDate) &&
          (!endDate || date <= endDate)
        );
      });
      const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
      currentPage = Math.min(currentPage, totalPages || 1);
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageTransactions = filteredTransactions.slice(start, end);
      pageTransactions.forEach((t, index) => {
        if (t && t.date && t.displayType && t.code && t.trees !== undefined && t.meters !== undefined && t.stockTrees !== undefined && t.stockMeters !== undefined) {
          const globalIndex = start + index;
          const row = `
            <tr>
              <td>${t.date}</td>
              <td>${t.displayType}</td>
              <td>${t.code}</td>
              <td>${t.trees}</td>
              <td>${t.meters.toFixed(1)} m</td>
              <td>${t.stockTrees}</td>
              <td>${t.stockMeters.toFixed(1)} m</td>
              <td>
                <button class="btn btn-sm btn-warning action-btn edit-btn" data-index="${globalIndex}">Sửa</button>
                <button class="btn btn-sm btn-danger action-btn delete-btn" data-index="${globalIndex}">Xóa</button>
              </td>
            </tr>`;
          transactionsBody.innerHTML += row;
        }
      });

      // Gắn sự kiện cho nút Sửa và Xóa
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index'));
          editTransaction(index);
        });
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index'));
          deleteTransaction(index);
        });
      });

      // Cập nhật phân trang lịch sử
      document.getElementById('pageInfo').textContent = `Trang ${currentPage}/${totalPages || 1}`;
      document.getElementById('prevPageButton').disabled = currentPage === 1;
      document.getElementById('nextPageButton').disabled = currentPage === totalPages || totalPages === 0;
    }

    // Xử lý lệnh từ form
    function processFormCommand() {
      console.log('processFormCommand called');
      const type = document.getElementById('formType').value;
      const code = document.getElementById('formCode').value.trim().toUpperCase();
      let trees = parseInt(document.getElementById('formTrees').value);
      let meters = parseFloat(document.getElementById('formMeters').value);
      const date = document.getElementById('formDate').value || today;

      if (!code || code.length !== 6) {
        document.getElementById('output').textContent = 'Mã vải phải có đúng 6 ký tự!';
        return;
      }

      let formattedMeters = meters;
      if (trees === 0) {
        formattedMeters = 0;
      } else if (isNaN(trees) || trees < 0 || isNaN(meters) || meters < 0) {
        document.getElementById('output').textContent = 'Vui lòng nhập số cây và số mét hợp lệ!';
        return;
      } else {
        const metersStr = meters.toString();
        const decimalPart = metersStr.split('.')[1];
        if (decimalPart && decimalPart.length > 1) {
          document.getElementById('output').textContent = 'Số mét chỉ được có 1 chữ số thập phân!';
          return;
        }
        formattedMeters = parseFloat(meters.toFixed(1));
      }

      const formattedCode = code.slice(0, 3) + '-' + code.slice(3);
      const formattedDate = new Date(date).toLocaleDateString('vi-VN');
      let stockTrees = (inventory[formattedCode]?.trees || 0);
      let stockMeters = (inventory[formattedCode]?.meters || 0);

      if (type === 'n') {
        stockTrees += trees;
        stockMeters += formattedMeters;
        pendingCommand = { date: formattedDate, type, displayType: 'nhập', code: formattedCode, trees, meters: formattedMeters, stockTrees, stockMeters };
        showConfirmation(`Xác nhận nhập mã ${formattedCode} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}? Tồn kho sẽ là ${stockTrees} cây, ${stockMeters.toFixed(1)} mét.`, () => {
          if (trees > 0 || formattedMeters > 0) {
            activeInputs.push({
              id: inputIdCounter++,
              date: formattedDate,
              code: formattedCode,
              trees,
              meters: formattedMeters
            });
          }
          inventory[formattedCode] = { trees: stockTrees, meters: stockMeters };
          transactions.push(pendingCommand);
          saveData();
          updateUI();
          document.getElementById('output').textContent = 'Đã cập nhật thành công!';
          pendingCommand = null;
          document.getElementById('formCode').value = '';
          document.getElementById('formTrees').value = '0';
          document.getElementById('formMeters').value = '0.0';
        });
      } else if (type === 'x') {
        if (trees === 0 && formattedMeters === 0) {
          pendingCommand = { date: formattedDate, type, displayType: 'xuất', code: formattedCode, trees, meters: formattedMeters, stockTrees, stockMeters };
          showConfirmation(`Xác nhận xuất mã ${formattedCode} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}? Tồn kho sẽ là ${stockTrees} cây, ${stockMeters.toFixed(1)} mét.`, () => {
            inventory[formattedCode] = { trees: stockTrees, meters: stockMeters };
            transactions.push(pendingCommand);
            saveData();
            updateUI();
            document.getElementById('output').textContent = 'Đã cập nhật thành công!';
            pendingCommand = null;
            document.getElementById('formCode').value = '';
            document.getElementById('formTrees').value = '0';
            document.getElementById('formMeters').value = '0.0';
          });
        } else {
          if ((inventory[formattedCode]?.trees || 0) < trees || (inventory[formattedCode]?.meters || 0) < formattedMeters) {
            document.getElementById('output').textContent = `Lỗi: Không đủ tồn kho mã ${formattedCode}. Tồn kho hiện tại: ${inventory[formattedCode]?.trees || 0} cây, ${(inventory[formattedCode]?.meters || 0).toFixed(1)} mét.`;
            return;
          }
          let remainingTrees = trees;
          let remainingMeters = formattedMeters;
          const matchingInputs = activeInputs.filter(t => t.code === formattedCode && t.trees > 0).sort((a, b) => {
            const dateA = new Date(a.date.split('/').reverse().join('-'));
            const dateB = new Date(b.date.split('/').reverse().join('-'));
            return dateA - dateB;
          });
          const updatedInputs = [...activeInputs];
          let valid = false;
          for (let input of matchingInputs) {
            if (remainingTrees <= 0 || remainingMeters <= 0) break;
            const inputIndex = updatedInputs.findIndex(t => t.id === input.id);
            const metersPerTree = input.meters / input.trees;
            if (metersPerTree === formattedMeters / trees) {
              const treesToDeduct = Math.min(remainingTrees, input.trees);
              const metersToDeduct = treesToDeduct * metersPerTree;
              updatedInputs[inputIndex].trees -= treesToDeduct;
              updatedInputs[inputIndex].meters -= metersToDeduct;
              remainingTrees -= treesToDeduct;
              remainingMeters -= metersToDeduct;
              valid = true;
            }
          }
          if (!valid || remainingTrees > 0 || remainingMeters > 0) {
            document.getElementById('output').textContent = `Lỗi: Không tìm thấy giao dịch nhập phù hợp cho ${trees} cây, ${formattedMeters.toFixed(1)} mét mã ${formattedCode}.`;
            return;
          }
          stockTrees -= trees;
          stockMeters -= formattedMeters;
          pendingCommand = { date: formattedDate, type, displayType: 'xuất', code: formattedCode, trees, meters: formattedMeters, stockTrees, stockMeters };
          showConfirmation(`Xác nhận xuất mã ${formattedCode} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}? Tồn kho sẽ là ${stockTrees} cây, ${stockMeters.toFixed(1)} mét.`, () => {
            activeInputs = updatedInputs.filter(t => t.trees > 0);
            inventory[formattedCode] = { trees: stockTrees, meters: stockMeters };
            transactions.push(pendingCommand);
            saveData();
            updateUI();
            document.getElementById('output').textContent = 'Đã cập nhật thành công!';
            pendingCommand = null;
            document.getElementById('formCode').value = '';
            document.getElementById('formTrees').value = '0';
            document.getElementById('formMeters').value = '0.0';
          });
        }
      }
    }

    // Hiển thị popup xác nhận
    function showConfirmation(message, callback) {
      console.log('showConfirmation called:', message);
      document.getElementById('confirmationMessage').textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      modal.show();
      const confirmButton = document.getElementById('confirmButton');
      // Xóa sự kiện cũ
      const newConfirmButton = confirmButton.cloneNode(true);
      confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
      newConfirmButton.addEventListener('click', () => {
        console.log('Confirm button clicked');
        if (callback) callback();
        modal.hide();
      });
    }

    // Xóa giao dịch
    function deleteTransaction(index) {
      console.log('deleteTransaction called:', index);
      showConfirmation('Bạn có chắc muốn xóa giao dịch này?', () => {
        const transaction = transactions[index];
        if (transaction.type === 'n') {
          activeInputs = activeInputs.filter(t => !(t.code === transaction.code && t.trees === transaction.trees && t.meters === transaction.meters && t.date === transaction.date));
        } else if (transaction.type === 'x' && (transaction.trees > 0 || transaction.meters > 0)) {
          const matchingInputs = transactions.slice(0, index).reverse().filter(t => t.type === 'n' && t.code === transaction.code);
          let treesToRestore = transaction.trees;
          let metersToRestore = transaction.meters;
          for (let input of matchingInputs) {
            if (treesToRestore <= 0 || metersToRestore <= 0) break;
            const metersPerTree = input.meters / input.trees;
            if (metersPerTree === metersToRestore / treesToRestore) {
              const existingInput = activeInputs.find(t => t.code === input.code && t.date === input.date && t.trees === 0);
              if (existingInput) {
                existingInput.trees += input.trees;
                existingInput.meters += input.meters;
              } else {
                activeInputs.push({
                  id: inputIdCounter++,
                  date: input.date,
                  code: input.code,
                  trees: input.trees,
                  meters: input.meters
                });
              }
              treesToRestore -= input.trees;
              metersToRestore -= input.meters;
            }
          }
        }
        transactions.splice(index, 1);
        recalculateInventory();
        saveData();
        updateUI();
        document.getElementById('output').textContent = 'Đã xóa giao dịch!';
      });
    }

    // Chỉnh sửa giao dịch
    function editTransaction(index) {
      console.log('editTransaction called:', index);
      editingIndex = index;
      const t = transactions[index];
      if (!t) return;
      document.getElementById('editType').value = t.type;
      document.getElementById('editCode').value = t.code.replace('-', '');
      document.getElementById('editMeters').value = t.meters.toFixed(1);
      document.getElementById('editTrees').value = t.trees;
      const [day, month, year] = t.date.split('/');
      document.getElementById('editDate').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    }

    // Lưu giao dịch đã chỉnh sửa
    function saveEditTransaction() {
      console.log('saveEditTransaction called');
      const type = document.getElementById('editType').value;
      const code = document.getElementById('editCode').value.trim().toUpperCase();
      let trees = parseInt(document.getElementById('editTrees').value);
      let meters = parseFloat(document.getElementById('editMeters').value);
      const date = document.getElementById('editDate').value;

      if (!code || code.length !== 6) {
        document.getElementById('output').textContent = 'Mã vải phải có đúng 6 ký tự!';
        return;
      }

      let formattedMeters = meters;
      if (trees === 0) {
        formattedMeters = 0;
      } else if (isNaN(trees) || trees < 0 || isNaN(meters) || meters < 0) {
        document.getElementById('output').textContent = 'Vui lòng nhập số cây và số mét hợp lệ!';
        return;
      } else {
        const metersStr = meters.toString();
        const decimalPart = metersStr.split('.')[1];
        if (decimalPart && decimalPart.length > 1) {
          document.getElementById('output').textContent = 'Số mét chỉ được có 1 chữ số thập phân!';
          return;
        }
        formattedMeters = parseFloat(meters.toFixed(1));
      }

      const formattedCode = code.slice(0, 3) + '-' + code.slice(3);
      const formattedDate = new Date(date).toLocaleDateString('vi-VN');
      const displayType = type === 'n' ? 'nhập' : 'xuất';

      const oldTransaction = transactions[editingIndex];
      if (oldTransaction.type === 'n') {
        activeInputs = activeInputs.filter(t => !(t.code === oldTransaction.code && t.trees === oldTransaction.trees && t.meters === oldTransaction.meters && t.date === oldTransaction.date));
      } else if (oldTransaction.type === 'x' && (oldTransaction.trees > 0 || oldTransaction.meters > 0)) {
        const matchingInputs = transactions.slice(0, editingIndex).reverse().filter(t => t.type === 'n' && t.code === oldTransaction.code);
        let treesToRestore = oldTransaction.trees;
        let metersToRestore = oldTransaction.meters;
        for (let input of matchingInputs) {
          if (treesToRestore <= 0 || metersToRestore <= 0) break;
          const metersPerTree = input.meters / input.trees;
          if (metersPerTree === metersToRestore / treesToRestore) {
            const existingInput = activeInputs.find(t => t.code === input.code && t.date === input.date && t.trees === 0);
            if (existingInput) {
              existingInput.trees += input.trees;
              existingInput.meters += input.meters;
            } else {
              activeInputs.push({
                id: inputIdCounter++,
                date: input.date,
                code: input.code,
                trees: input.trees,
                meters: input.meters
              });
            }
            treesToRestore -= input.trees;
            metersToRestore -= input.meters;
          }
        }
      }

      let stockTrees = (inventory[formattedCode]?.trees || 0);
      let stockMeters = (inventory[formattedCode]?.meters || 0);
      if (type === 'n') {
        stockTrees += trees;
        stockMeters += formattedMeters;
        if (trees > 0 || formattedMeters > 0) {
          activeInputs.push({
            id: inputIdCounter++,
            date: formattedDate,
            code: formattedCode,
            trees,
            meters: formattedMeters
          });
        }
      } else if (type === 'x') {
        if (trees === 0 && formattedMeters === 0) {
          // Giao dịch xuất 0 cây, 0 mét
        } else {
          if ((inventory[formattedCode]?.trees || 0) < trees || (inventory[formattedCode]?.meters || 0) < formattedMeters) {
            document.getElementById('output').textContent = `Lỗi: Không đủ tồn kho mã ${formattedCode}.`;
            return;
          }
          let remainingTrees = trees;
          let remainingMeters = formattedMeters;
          const matchingInputs = activeInputs.filter(t => t.code === formattedCode && t.trees > 0).sort((a, b) => {
            const dateA = new Date(a.date.split('/').reverse().join('-'));
            const dateB = new Date(b.date.split('/').reverse().join('-'));
            return dateA - dateB;
          });
          const updatedInputs = [...activeInputs];
          let valid = false;
          for (let input of matchingInputs) {
            if (remainingTrees <= 0 || remainingMeters <= 0) break;
            const inputIndex = updatedInputs.findIndex(t => t.id === input.id);
            const metersPerTree = input.meters / input.trees;
            if (metersPerTree === formattedMeters / trees) {
              const treesToDeduct = Math.min(remainingTrees, input.trees);
              const metersToDeduct = treesToDeduct * metersPerTree;
              updatedInputs[inputIndex].trees -= treesToDeduct;
              updatedInputs[inputIndex].meters -= metersToDeduct;
              remainingTrees -= treesToDeduct;
              remainingMeters -= metersToDeduct;
              valid = true;
            }
          }
          if (!valid || remainingTrees > 0 || remainingMeters > 0) {
            document.getElementById('output').textContent = `Lỗi: Không tìm thấy giao dịch nhập phù hợp cho ${trees} cây, ${formattedMeters.toFixed(1)} mét mã ${formattedCode}.`;
            return;
          }
          activeInputs = updatedInputs.filter(t => t.trees > 0);
          stockTrees -= trees;
          stockMeters -= formattedMeters;
        }
      }

      transactions[editingIndex] = { date: formattedDate, type, displayType, code: formattedCode, trees, meters: formattedMeters, stockTrees, stockMeters };
      recalculateInventory();
      saveData();
      updateUI();
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      document.getElementById('output').textContent = 'Đã chỉnh sửa giao dịch!';
      editingIndex = null;
    }

    // Áp dụng bộ lọc tồn kho
    function applyInventoryFilter() {
      console.log('applyInventoryFilter called');
      updateUI();
    }

    // Áp dụng bộ lọc lịch sử
    function applyFilter() {
      console.log('applyFilter called');
      currentFilter.code = document.getElementById('filterCode').value;
      currentFilter.startDate = document.getElementById('filterStartDate').value;
      currentFilter.endDate = document.getElementById('filterEndDate').value;
      currentPage = 1;
      updateUI();
    }

    // Xóa bộ lọc lịch sử
    function clearHistoryFilter() {
      console.log('clearHistoryFilter called');
      document.getElementById('filterCode').value = '';
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      currentFilter = { code: '', startDate: '', endDate: '' };
      currentPage = 1;
      updateUI();
    }

    // Chuyển trang trước (lịch sử)
    function prevPage() {
      console.log('prevPage called');
      if (currentPage > 1) {
        currentPage--;
        updateUI();
      }
    }

    // Chuyển trang sau (lịch sử)
    function nextPage() {
      console.log('nextPage called');
      const filteredTransactions = transactions.filter(t => {
        if (!t || !t.date || !t.code) return false;
        const [day, month, year] = t.date.split('/');
        const date = new Date(`${year}-${month}-${day}`);
        if (isNaN(date)) return false;
        const startDate = currentFilter.startDate ? new Date(currentFilter.startDate) : null;
        const endDate = currentFilter.endDate ? new Date(currentFilter.endDate) : null;
        return (
          (!currentFilter.code || t.code === currentFilter.code) &&
          (!startDate || date >= startDate) &&
          (!endDate || date <= endDate)
        );
      });
      const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updateUI();
      }
    }

    // Tab Quản lý dữ liệu: Xác nhận và xử lý
    function showExportInventoryConfirmation() {
      console.log('showExportInventoryConfirmation called');
      showConfirmation('Xác nhận xuất dữ liệu tồn kho?', () => {
        console.log('Export inventory confirmed');
        const headers = ['Mã vải', 'Số cây', 'Số mét'];
        const rows = Object.keys(inventory).map(code => [
          `"${code}"`,
          inventory[code].trees,
          inventory[code].meters.toFixed(1)
        ]);
        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.join(','))
        ].join('\n');
        const BOM = '\uFEFF'; // Thêm BOM để hỗ trợ UTF-8 trên Excel
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
        a.href = url;
        a.download = `tonkho_${date}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('output').textContent = 'Đã xuất dữ liệu tồn kho!';
      });
    }

    function showImportConfirmation() {
      console.log('showImportConfirmation called');
      const fileInput = document.getElementById('importTransactions');
      const file = fileInput.files[0];
      if (!file) {
        document.getElementById('output').textContent = 'Vui lòng chọn file CSV!';
        return;
      }
      if (!file.name.endsWith('.csv')) {
        document.getElementById('output').textContent = 'Vui lòng chọn file CSV!';
        return;
      }
      showConfirmation('Import sẽ ghi đè dữ liệu hiện tại. Bạn có chắc muốn tiếp tục?', () => {
        console.log('Import confirmed');
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const lines = text.split('\n').map(line => {
              const values = [];
              let current = '';
              let inQuotes = false;
              for (let char of line) {
                if (char === '"') {
                  inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                  values.push(current.trim());
                  current = '';
                } else {
                  current += char;
                }
              }
              values.push(current.trim());
              return values;
            });
            if (lines.length < 1 || lines[0].length < 4 || lines[0][0].toLowerCase() !== 'ngày') {
              document.getElementById('output').textContent = 'File CSV không hợp lệ! Đảm bảo có cột: Ngày, Mã vải, Số cây, Số mét.';
              return;
            }
            const newTransactions = [];
            const newActiveInputs = [];
            for (let i = 1; i < lines.length; i++) {
              const [date, code, trees, meters] = lines[i].map(v => v.replace(/^"|"$/g, ''));
              if (date && code && trees && meters) {
                if (!/^\w{3}-\w{3}$/.test(code)) {
                  document.getElementById('output').textContent = `Mã vải không hợp lệ ở dòng ${i + 1}: ${code}`;
                  return;
                }
                const parsedTrees = parseInt(trees);
                const parsedMeters = parseFloat(meters);
                if (isNaN(parsedTrees) || parsedTrees < 0 || isNaN(parsedMeters) || parsedMeters < 0) {
                  document.getElementById('output').textContent = `Dữ liệu không hợp lệ ở dòng ${i + 1}: Số cây hoặc số mét không hợp lệ`;
                  return;
                }
                if (parsedTrees > 0 || parsedMeters > 0) {
                  newActiveInputs.push({
                    id: inputIdCounter++,
                    date,
                    code,
                    trees: parsedTrees,
                    meters: parsedMeters
                  });
                }
                newTransactions.push({
                  date,
                  type: 'n',
                  displayType: 'nhập',
                  code,
                  trees: parsedTrees,
                  meters: parsedMeters,
                  stockTrees: 0,
                  stockMeters: 0
                });
              }
            }
            if (newTransactions.length === 0) {
              document.getElementById('output').textContent = 'File CSV không chứa dữ liệu hợp lệ!';
              return;
            }
            transactions = newTransactions;
            activeInputs = newActiveInputs;
            recalculateInventory();
            transactions.forEach(t => {
              t.stockTrees = inventory[t.code]?.trees || 0;
              t.stockMeters = inventory[t.code]?.meters || 0;
            });
            currentPage = 1;
            saveData();
            updateUI();
            document.getElementById('output').textContent = 'Đã import dữ liệu thành công!';
            fileInput.value = '';
          } catch (error) {
            console.error('Lỗi đọc file CSV:', error);
            document.getElementById('output').textContent = 'Lỗi đọc file CSV!';
          }
        };
        reader.onerror = function() {
          document.getElementById('output').textContent = 'Lỗi đọc file CSV!';
        };
        reader.readAsText(file);
      });
    }

    function showExportDataConfirmation() {
      console.log('showExportDataConfirmation called');
      showConfirmation('Xác nhận xuất dữ liệu giao dịch?', () => {
        console.log('Export data confirmed');
        const headers = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét', 'Tồn kho (cây)', 'Tồn kho (mét)'];
        const rows = transactions.map(t => [
          `"${t.date}"`,
          `"${t.displayType}"`,
          `"${t.code}"`,
          t.trees,
          t.meters.toFixed(1),
          t.stockTrees,
          t.stockMeters.toFixed(1)
        ]);
        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.join(','))
        ].join('\n');
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
        a.href = url;
        a.download = `tonkho_lichsu_${date}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('output').textContent = 'Đã xuất dữ liệu giao dịch!';
      });
    }

    function showClearAllConfirmation() {
      console.log('showClearAllConfirmation called');
      showConfirmation('Xóa toàn bộ dữ liệu? Hành động này không thể hoàn tác.', () => {
        console.log('Clear all confirmed');
        inventory = {};
        transactions = [];
        activeInputs = [];
        inputIdCounter = 1;
        currentPage = 1;
        saveData();
        updateUI();
        document.getElementById('output').textContent = 'Đã xóa toàn bộ dữ liệu!';
      });
    }

    // Gắn sự kiện cho các nút
    document.getElementById('processFormButton').addEventListener('click', processFormCommand);
    document.getElementById('applyInventoryFilterButton').addEventListener('click', applyInventoryFilter);
    document.getElementById('applyFilterButton').addEventListener('click', applyFilter);
    document.getElementById('clearHistoryFilterButton').addEventListener('click', clearHistoryFilter);
    document.getElementById('prevPageButton').addEventListener('click', prevPage);
    document.getElementById('nextPageButton').addEventListener('click', nextPage);
    document.getElementById('exportInventoryButton').addEventListener('click', showExportInventoryConfirmation);
    document.getElementById('importTransactionsButton').addEventListener('click', showImportConfirmation);
    document.getElementById('exportDataButton').addEventListener('click', showExportDataConfirmation);
    document.getElementById('clearAllButton').addEventListener('click', showClearAllConfirmation);
    document.getElementById('saveEditButton').addEventListener('click', saveEditTransaction);

    // Tải dữ liệu khi khởi động
    loadData();
  </script>
</body>
</html>
