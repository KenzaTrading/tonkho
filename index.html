<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý kho vải</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #F8FAFC;
      padding: 20px;
      color: #2D3748;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      background: #FFFFFF;
    }
    .nav-tabs {
      border-bottom: none;
      background: #F8FAFC;
      padding: 10px 10px 0;
      border-radius: 12px 12px 0 0;
    }
    .nav-link {
      color: #718096;
      font-weight: 500;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s;
    }
    .nav-link:hover {
      background: #E6F0FA;
      color: #4A90E2;
    }
    .nav-link.active {
      background: #E6F0FA;
      color: #4A90E2;
      font-weight: 600;
    }
    .tab-content {
      padding: 25px;
      background: #FFFFFF;
      border-radius: 0 0 12px 12px;
    }
    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #4A90E2;
      margin-bottom: 20px;
    }
    h5 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    .btn {
      border-radius: 6px;
      font-size: 14px;
      padding: 10px 20px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #4A90E2;
      border: none;
    }
    .btn-primary:hover {
      background: #357ABD;
    }
    .btn-success {
      background: #38A169;
      border: none;
    }
    .btn-success:hover {
      background: #2F855A;
    }
    .btn-danger {
      background: #E53E3E;
      border: none;
    }
    .btn-danger:hover {
      background: #C53030;
    }
    .form-control, .form-select {
      border-radius: 6px;
      border: 1px solid #E2E8F0;
      font-size: 14px;
      padding: 10px;
    }
    .form-control:focus, .form-select:focus {
      border-color: #4A90E2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }
    #output {
      margin-top: 15px;
      padding: 12px;
      background: #EDF2F7;
      border-radius: 6px;
      font-size: 14px;
      color: #2D3748;
    }
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .table {
      font-size: 14px;
      border-collapse: separate;
      border-spacing: 0;
    }
    .table th {
      background: #F8FAFC;
      position: sticky;
      top: 0;
      z-index: 1;
      padding: 12px;
      font-weight: 500;
      border-bottom: 2px solid #E2E8F0;
    }
    .table td {
      padding: 12px;
      border-bottom: 1px solid #E2E8F0;
      vertical-align: middle;
    }
    .table tr:hover {
      background: #F7FAFC;
    }
    .total-row {
      background: #EDF2F7;
      font-weight: 600;
    }
    .action-btn {
      padding: 6px 12px;
      font-size: 13px;
      margin-right: 5px;
    }
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination-section {
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .pagination-btn {
      padding: 6px 12px;
      font-size: 13px;
    }
    .file-input-wrapper input[type="file"] {
      font-size: 14px;
      padding: 10px;
    }
    .manage-section .delete-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #E2E8F0;
      text-align: center;
    }
    #latest-inventory-table th, #latest-inventory-table td {
      text-align: center; /* Căn giữa bảng cập nhật mới nhất */
    }
    #inventory-table-container th, #inventory-table-container td {
      text-align: center !important; /* Căn giữa bảng tồn kho, ưu tiên cao */
    }
    @media (max-width: 576px) {
      body {
        padding: 10px;
      }
      h1 {
        font-size: 20px;
      }
      h5 {
        font-size: 14px;
      }
      .nav-link {
        padding: 10px 15px;
        font-size: 14px;
      }
      .tab-content {
        padding: 15px;
      }
      .btn {
        width: 100%;
        margin-bottom: 10px;
        font-size: 14px;
        padding: 12px;
      }
      .form-control, .form-select {
        font-size: 14px;
      }
      .table {
        font-size: 13px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      .table-container {
        max-height: 300px;
      }
      .pagination-section {
        flex-direction: column;
        align-items: stretch;
      }
      .action-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
      .row.g-3 > div {
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">Quản lý kho vải</h1>
    <div class="card">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input">Nhập liệu</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory">Tồn kho</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history">Lịch sử giao dịch</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage">Quản lý dữ liệu</button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="input">
          <div class="form-section">
            <h5>Nhập liệu</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="formType" class="form-label">Loại lệnh:</label>
                <select class="form-select" id="formType">
                  <option value="n">Nhập</option>
                  <option value="x">Xuất</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="formCode" class="form-label">Mã vải:</label>
                <input type="text" class="form-control" id="formCode" placeholder="VD: 950001">
              </div>
              <div class="col-md-2 col-12">
                <label for="formTrees" class="form-label">Số cây:</label>
                <input type="number" min="0" step="1" class="form-control" id="formTrees" value="0">
              </div>
              <div class="col-md-2 col-12">
                <label for="formMeters" class="form-label">Số mét:</label>
                <input type="number" step="0.1" class="form-control" id="formMeters" value="0.0">
              </div>
              <div class="col-md-2 col-12">
                <label for="formDate" class="form-label">Ngày:</label>
                <input type="date" class="form-control" id="formDate">
              </div>
            </div>
            <button class="btn btn-primary mt-3" id="processFormButton">Thực hiện</button>
          </div>
          <div id="output" class="text-center">Kết quả sẽ hiển thị ở đây...</div>
          <h5 class="mt-4">Cập nhật mới nhất</h5>
          <table class="table table-bordered" id="latest-inventory-table">
            <thead><tr><th>Mã vải</th><th>Số cây</th><th>Số mét</th></tr></thead>
            <tbody id="latest-inventory"></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="inventory">
          <div class="filter-section">
            <h5>Lọc tồn kho</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="filterFabricType" class="form-label">Loại vải:</label>
                <select class="form-select" id="filterFabricType">
                  <option value="">Tất cả loại vải</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="filterColor" class="form-label">Màu:</label>
                <select class="form-select" id="filterColor">
                  <option value="">Tất cả màu</option>
                </select>
              </div>
              <div class="col-md-3 col-12 d-flex align-items-end">
                <button class="btn btn-primary" id="applyInventoryFilterButton">Thực hiện</button>
              </div>
            </div>
          </div>
          <h5 class="mt-2">Tồn kho</h5>
          <div class="table-container">
            <table class="table table-bordered" id="inventory-table-container">
              <thead><tr><th>Mã vải</th><th>Số cây</th><th>Số mét</th><th>Hành động</th></tr></thead>
              <tbody id="inventory-table"></tbody>
              <tfoot>
                <tr class="total-row">
                  <td>Tổng cộng</td>
                  <td id="total-trees"></td>
                  <td id="total-meters"></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="history">
          <div class="filter-section">
            <h5>Lọc giao dịch</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="filterCode" class="form-label">Mã vải:</label>
                <select class="form-select" id="filterCode">
                  <option value="">Tất cả mã</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="filterStartDate" class="form-label">Từ ngày:</label>
                <input type="date" class="form-control" id="filterStartDate">
              </div>
              <div class="col-md-3 col-12">
                <label for="filterEndDate" class="form-label">Đến ngày:</label>
                <input type="date" class="form-control" id="filterEndDate">
              </div>
              <div class="col-md-3 col-12 d-flex align-items-end">
                <button class="btn btn-primary" id="applyFilterButton">Thực hiện</button>
              </div>
            </div>
          </div>
          <h5 class="mt-2">Lịch sử giao dịch</h5>
          <div class="table-container">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Ngày</th>
                  <th>Loại</th>
                  <th>Mã vải</th>
                  <th>Số cây</th>
                  <th>Số mét</th>
                  <th>Tồn kho (cây)</th>
                  <th>Tồn kho (mét)</th>
                  <th>Hành động</th>
                </tr>
              </thead>
              <tbody id="transactions"></tbody>
            </table>
          </div>
          <div class="pagination-section">
            <button class="btn btn-outline-primary pagination-btn" id="prevPageButton" disabled>Trước</button>
            <span id="pageInfo">Trang 1/1</span>
            <button class="btn btn-outline-primary pagination-btn" id="nextPageButton" disabled>Sau</button>
          </div>
        </div>
        <div class="tab-pane fade" id="manage">
          <div class="manage-section">
            <h5>Quản lý dữ liệu</h5>
            <div class="row g-3">
              <div class="col-md-4 col-12">
                <button class="btn btn-success w-100" id="exportInventoryButton">Xuất dữ liệu tồn kho</button>
              </div>
              <div class="col-md-4 col-12">
                <div class="file-input-wrapper">
                  <input type="file" class="form-control" id="importInventoryFile" accept=".xlsx,.csv">
                </div>
                <button class="btn btn-primary w-100 mt-2" id="importInventoryButton" disabled>Nhập dữ liệu tồn kho</button>
              </div>
              <div class="col-md-4 col-12">
                <button class="btn btn-success w-100" id="exportTransactionsButton">Xuất lịch sử giao dịch</button>
              </div>
            </div>
            <div class="delete-section">
              <button class="btn btn-danger" id="deleteAllTransactionsButton">Xóa lịch sử giao dịch</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="confirmationModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xác nhận</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmationMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="confirmButton">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const DOM = {
      output: document.getElementById('output'),
      latestInventory: document.getElementById('latest-inventory'),
      inventoryTable: document.getElementById('inventory-table'),
      totalTrees: document.getElementById('total-trees'),
      totalMeters: document.getElementById('total-meters'),
      transactions: document.getElementById('transactions'),
      pageInfo: document.getElementById('pageInfo'),
      prevPageButton: document.getElementById('prevPageButton'),
      nextPageButton: document.getElementById('nextPageButton'),
      filterFabricType: document.getElementById('filterFabricType'),
      filterColor: document.getElementById('filterColor'),
      filterCode: document.getElementById('filterCode')
    };

    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    };

    // Hàm định dạng số với phân cách hàng ngàn và 1 số thập phân
    const formatNumber = (num, decimals = 1) => {
      return parseFloat(num)
        .toFixed(decimals)
        .replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };

    class InventoryManager {
      constructor() {
        this.inventory = [];
        this.transactions = [];
        this.today = new Date().toISOString().split('T')[0];
        this.currentFilter = { code: '', startDate: '', endDate: '' };
        this.filterInventory = { fabricType: '', color: '' };
        this.currentPage = 1;
        this.itemsPerPage = 10;
        this.latestCode = null;
        this.editingIndex = null;
      }

      validateTransaction(code, trees, meters) {
        if (!/^\w{6}$/.test(code)) return 'Mã vải phải có đúng 6 ký tự!';
        if (isNaN(trees) || trees < 0 || isNaN(meters) || meters < 0) return 'Số cây và số mét phải hợp lệ!';
        if (trees === 0 && meters !== 0) return 'Nếu số cây là 0, số mét phải là 0!';
        const decimalPart = meters.toString().split('.')[1];
        if (decimalPart && decimalPart.length > 1) return 'Số mét chỉ được có 1 chữ số thập phân!';
        return null;
      }

      parseDate(dateStr) {
        if (!dateStr) return null;
        let date;
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          const [year, month, day] = dateStr.split('-').map(Number);
          date = new Date(year, month - 1, day);
        } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
          const [day, month, year] = dateStr.split('/').map(Number);
          date = new Date(year, month - 1, day);
        } else {
          console.warn('Invalid date format:', dateStr);
          return null;
        }
        if (isNaN(date)) return null;
        return date;
      }

      formatDate(dateStr) {
        const date = this.parseDate(dateStr);
        if (!date) return '';
        return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      cleanZeroLines() {
        this.inventory = this.inventory.filter(line => {
          if (line.trees === 0 && line.meters === 0) {
            const otherLines = this.inventory.filter(l => l.code === line.code && (l.trees > 0 || l.meters > 0));
            return otherLines.length === 0;
          }
          return true;
        });
      }

      sortTransactions() {
        this.transactions.sort((a, b) => this.parseDate(b.date) - this.parseDate(a.date));
      }

      rebuildInventory() {
        const transactions = [...this.transactions];
        this.inventory = [];
        this.transactions = [];
        transactions.sort((a, b) => this.parseDate(a.date) - this.parseDate(b.date));
        for (const t of transactions) {
          this.addTransaction(t.type, t.code.replace('-', ''), t.trees, t.meters, t.date, true);
        }
        this.sortTransactions();
      }

      addTransaction(type, code, trees, meters, date, skipRebuild = false) {
        const formattedCode = code.slice(0, 3) + '-' + code.slice(3);
        const formattedMeters = parseFloat(meters.toFixed(1));
        const formattedDate = this.formatDate(date);
        if (!formattedDate) return { success: false, error: 'Ngày không hợp lệ!' };

        if (type === 'n') {
          this.inventory.push({ code: formattedCode, trees, meters: formattedMeters, date: formattedDate });
        } else {
          let remainingTrees = trees;
          let remainingMeters = formattedMeters;
          const stockLines = this.inventory.filter(line => line.code === formattedCode && line.trees > 0);
          stockLines.sort((a, b) => this.parseDate(a.date) - this.parseDate(b.date));

          let totalStockTrees = stockLines.reduce((sum, line) => sum + line.trees, 0);
          let totalStockMeters = stockLines.reduce((sum, line) => sum + line.meters, 0);
          if (totalStockTrees < trees || totalStockMeters < meters) {
            return { success: false, error: `Không đủ tồn kho mã ${formattedCode}. Tồn kho: ${totalStockTrees} cây, ${totalStockMeters.toFixed(1)} mét.` };
          }

          for (let line of stockLines) {
            if (remainingTrees <= 0 && remainingMeters <= 0) break;
            if (line.trees <= 0) continue;

            const treesToTake = Math.min(line.trees, remainingTrees);
            const metersPerTree = line.meters / line.trees;
            const metersToTake = treesToTake * metersPerTree;

            if (metersToTake <= remainingMeters) {
              line.trees -= treesToTake;
              line.meters -= metersToTake;
              remainingTrees -= treesToTake;
              remainingMeters -= metersToTake;
            }
          }

          if (remainingTrees > 0 || remainingMeters > 0) {
            return { success: false, error: `Không thể xuất mã ${formattedCode} với số cây/mét yêu cầu.` };
          }
        }

        if (!skipRebuild) this.cleanZeroLines();

        const stockLines = this.inventory.filter(line => line.code === formattedCode);
        const stockTrees = stockLines.reduce((sum, line) => sum + line.trees, 0);
        const stockMeters = stockLines.reduce((sum, line) => sum + line.meters, 0);

        const transaction = {
          date: formattedDate,
          type,
          displayType: type === 'n' ? 'nhập' : 'xuất',
          code: formattedCode,
          trees,
          meters: formattedMeters,
          stockTrees,
          stockMeters
        };

        this.transactions.push(transaction);
        this.sortTransactions();
        this.latestCode = formattedCode;
        return { success: true, transaction, formattedCode };
      }

      editTransaction(index, type, code, trees, meters, date) {
        const oldTransaction = this.transactions[index];
        if (!oldTransaction) return { success: false, error: 'Giao dịch không tồn tại!' };

        this.transactions.splice(index, 1);
        this.rebuildInventory();

        const result = this.addTransaction(type, code, trees, meters, date);
        if (!result.success) {
          this.transactions.splice(index, 0, oldTransaction);
          this.rebuildInventory();
          return result;
        }
        return { success: true };
      }

      deleteTransaction(index) {
        const transaction = this.transactions[index];
        if (!transaction) return { success: false, error: 'Giao dịch không tồn tại!' };

        this.transactions.splice(index, 1);
        this.rebuildInventory();
        return { success: true };
      }

      deleteAllTransactions() {
        this.transactions = [];
        this.inventory = [];
        this.latestCode = null;
        return { success: true };
      }

      downloadCSV(csvContent, fileName) {
        try {
          const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = fileName;
          link.click();
          URL.revokeObjectURL(link.href);
          return { success: true, fileName };
        } catch (error) {
          return { success: false, error: 'Lỗi tải file CSV!' };
        }
      }

      exportInventoryToCSV() {
        const today = this.formatDate(this.today);
        const data = this.inventory.map(line => ({
          'Ngày': today,
          'Loại': 'Nhập',
          'Mã vải': line.code,
          'Số cây': line.trees,
          'Số mét': line.meters.toFixed(1)
        }));

        if (data.length === 0) return { success: false, error: 'Không có dữ liệu tồn kho để xuất!' };

        const headers = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'];
        const csvRows = [
          headers.join(','),
          ...data.map(row => [
            `"${row['Ngày']}"`,
            `"${row['Loại']}"`,
            `"${row['Mã vải']}"`,
            row['Số cây'],
            row['Số mét']
          ].join(','))
        ];
        const csvContent = csvRows.join('\n');
        const fileName = `TonKho_${this.today.replace(/-/g, '')}.csv`;
        return this.downloadCSV(csvContent, fileName);
      }

      exportTransactionsToCSV() {
        const data = this.transactions.map(t => ({
          'Ngày': t.date,
          'Loại': t.displayType,
          'Mã vải': t.code,
          'Số cây': t.trees,
          'Số mét': t.meters.toFixed(1),
          'Tồn kho (cây)': t.stockTrees,
          'Tồn kho (mét)': t.stockMeters.toFixed(1)
        }));

        if (data.length === 0) return { success: false, error: 'Không có lịch sử giao dịch để xuất!' };

        const headers = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét', 'Tồn kho (cây)', 'Tồn kho (mét)'];
        const csvRows = [
          headers.join(','),
          ...data.map(row => [
            `"${row['Ngày']}"`,
            `"${row['Loại']}"`,
            `"${row['Mã vải']}"`,
            row['Số cây'],
            row['Số mét'],
            row['Tồn kho (cây)'],
            row['Tồn kho (mét)']
          ].join(','))
        ];
        const csvContent = csvRows.join('\n');
        const fileName = `LichSuGiaoDich_${this.today.replace(/-/g, '')}.csv`;
        return this.downloadCSV(csvContent, fileName);
      }

      parseCSV(csvText) {
        const lines = csvText.replace(/^\uFEFF/, '').split('\n').filter(line => line.trim());
        if (lines.length === 0) return { success: false, error: 'File CSV rỗng!' };

        const parseCSVLine = (line) => {
          const values = [];
          let current = '';
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else current += char;
          }
          values.push(current.trim());
          return values;
        };

        const headers = parseCSVLine(lines[0]).map(h => h.trim());
        const expectedHeader = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'];
        if (!expectedHeader.every((col, i) => headers[i] === col)) {
          return { success: false, error: 'File CSV không đúng định dạng! Header phải là: ' + expectedHeader.join(',') };
        }

        const dataRows = lines.slice(1).map((line, index) => {
          const values = parseCSVLine(line);
          if (values.length !== headers.length) return { error: `Dòng ${index + 2} không đủ cột: ${line}` };
          return {
            'Ngày': values[0].replace(/^"|"$/g, ''),
            'Loại': values[1].replace(/^"|"$/g, ''),
            'Mã vải': values[2].replace(/^"|"$/g, ''),
            'Số cây': values[3],
            'Số mét': values[4]
          };
        });

        const errors = dataRows.filter(row => row.error).map(row => row.error);
        if (errors.length > 0) return { success: false, error: `Lỗi cú pháp CSV:\n${errors.join('\n')}` };
        return { success: true, data: dataRows };
      }

      importInventory(file) {
        return new Promise((resolve) => {
          const fileExtension = file.name.split('.').pop().toLowerCase();
          const reader = new FileReader();

          if (fileExtension === 'csv') {
            reader.onload = (e) => {
              try {
                const csvText = e.target.result;
                const csvResult = this.parseCSV(csvText);
                if (!csvResult.success) return resolve({ success: false, error: csvResult.error });

                const dataRows = csvResult.data;
                if (dataRows.length === 0) return resolve({ success: false, error: 'File CSV không chứa dữ liệu!' });

                const errors = [];
                for (let i = 0; i < dataRows.length; i++) {
                  const row = dataRows[i];
                  const { 'Ngày': date, 'Loại': type, 'Mã vải': code, 'Số cây': trees, 'Số mét': meters } = row;

                  if (!date || type !== 'Nhập' || !code || !trees || !meters) {
                    errors.push(`Dòng ${i + 2} không hợp lệ: ${JSON.stringify(row)}`);
                    continue;
                  }

                  const cleanCode = code.replace('-', '');
                  const parsedTrees = parseInt(trees);
                  const parsedMeters = parseFloat(meters);

                  if (isNaN(parsedTrees) || isNaN(parsedMeters)) {
                    errors.push(`Dòng ${i + 2}, mã ${code}: Số cây hoặc số mét không hợp lệ!`);
                    continue;
                  }

                  const error = this.validateTransaction(cleanCode, parsedTrees, parsedMeters);
                  if (error) {
                    errors.push(`Lỗi tại dòng ${i + 2}, mã ${code}: ${error}`);
                    continue;
                  }

                  const result = this.addTransaction('n', cleanCode, parsedTrees, parsedMeters, date);
                  if (!result.success) errors.push(`Lỗi thêm giao dịch tại dòng ${i + 2}, mã ${code}: ${result.error}`);
                }

                if (errors.length > 0) resolve({ success: false, error: `Có lỗi khi nhập dữ liệu:\n${errors.join('\n')}` });
                else resolve({ success: true });
              } catch (error) {
                resolve({ success: false, error: 'Lỗi đọc file CSV!' });
              }
            };
            reader.readAsText(file, 'UTF-8');
          } else if (fileExtension === 'xlsx') {
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'], defval: '' });

                if (json.length === 0) return resolve({ success: false, error: 'File Excel rỗng!' });

                const expectedHeader = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét'];
                const firstRow = json[0];
                const isHeader = expectedHeader.every((col, i) => firstRow[col] === col);
                const dataRows = isHeader ? json.slice(1) : json;

                if (dataRows.length === 0) return resolve({ success: false, error: 'File Excel không chứa dữ liệu hợp lệ!' });

                const errors = [];
                for (let i = 0; i < dataRows.length; i++) {
                  const row = dataRows[i];
                  const { 'Ngày': date, 'Loại': type, 'Mã vải': code, 'Số cây': trees, 'Số mét': meters } = row;
                  if (!date || type !== 'Nhập' || !code || isNaN(trees) || isNaN(meters)) {
                    errors.push(`Dòng ${i + (isHeader ? 2 : 1)} không hợp lệ: ${JSON.stringify(row)}`);
                    continue;
                  }
                  const cleanCode = code.toString().replace('-', '');
                  const error = this.validateTransaction(cleanCode, parseInt(trees), parseFloat(meters));
                  if (error) {
                    errors.push(`Lỗi tại dòng ${i + (isHeader ? 2 : 1)}, mã ${code}: ${error}`);
                    continue;
                  }
                  const formattedDate = date instanceof Date ? date.toLocaleDateString('vi-VN') : date;
                  const result = this.addTransaction('n', cleanCode, parseInt(trees), parseFloat(meters), formattedDate);
                  if (!result.success) errors.push(`Lỗi thêm giao dịch tại dòng ${i + (isHeader ? 2 : 1)}, mã ${code}: ${result.error}`);
                }

                if (errors.length > 0) resolve({ success: false, error: `Có lỗi khi nhập dữ liệu:\n${errors.join('\n')}` });
                else resolve({ success: true });
              } catch (error) {
                resolve({ success: false, error: 'Lỗi đọc file Excel!' });
              }
            };
            reader.readAsArrayBuffer(file);
          } else {
            resolve({ success: false, error: 'Định dạng file không hỗ trợ! Vui lòng chọn file .xlsx hoặc .csv.' });
          }
        });
      }

      getFilteredTransactions() {
        return this.transactions.filter(t => {
          const date = this.parseDate(t.date);
          if (!date || !t.code) return false;
          const startDate = this.currentFilter.startDate ? this.parseDate(this.currentFilter.startDate) : null;
          const endDate = this.currentFilter.endDate ? this.parseDate(this.currentFilter.endDate) : null;
          return (
            (!this.currentFilter.code || t.code === this.currentFilter.code) &&
            (!startDate || date >= startDate) &&
            (!endDate || date <= endDate)
          );
        });
      }

      getFilteredInventory() {
        const filtered = this.inventory.filter(line => {
          const fabricType = line.code.split('-')[0];
          const color = line.code.split('-')[1];
          return (
            (!this.filterInventory.fabricType || fabricType === this.filterInventory.fabricType) &&
            (!this.filterInventory.color || color === this.filterInventory.color)
          );
        });
        return filtered.sort((a, b) => a.code.localeCompare(b.code));
      }

      getFabricTypes() {
        return [...new Set(this.inventory.map(line => line.code.split('-')[0]))].sort();
      }

      getColors() {
        return [...new Set(this.inventory.map(line => line.code.split('-')[1]))].sort();
      }

      saveData() {
        try {
          const data = JSON.stringify({ inventory: this.inventory, transactions: this.transactions });
          if (data.length > 5 * 1024 * 1024) {
            console.error('Dữ liệu quá lớn cho localStorage');
            return false;
          }
          localStorage.setItem('inventory', JSON.stringify(this.inventory));
          localStorage.setItem('transactions', JSON.stringify(this.transactions));
          return true;
        } catch (error) {
          console.error('Lỗi lưu dữ liệu:', error);
          return false;
        }
      }

      loadData() {
        try {
          this.inventory = JSON.parse(localStorage.getItem('inventory') || '[]')
            .filter(line => line.code && line.trees >= 0 && line.meters >= 0 && line.date);
          this.transactions = JSON.parse(localStorage.getItem('transactions') || '[]')
            .filter(t => t.date && t.code && this.parseDate(t.date) && t.type && t.trees >= 0 && t.meters >= 0);
          this.sortTransactions();
          if (this.transactions.length > 0) this.latestCode = this.transactions[0].code;
          this.cleanZeroLines();
        } catch (error) {
          console.error('Lỗi tải dữ liệu:', error);
        }
      }
    }

    const inventoryManager = new InventoryManager();

    const showOutput = (msg) => {
      if (DOM.output) DOM.output.textContent = msg;
    };

    const showConfirmation = (message, callback) => {
      const confirmationMessage = document.getElementById('confirmationMessage');
      if (!confirmationMessage) {
        showOutput('Lỗi hiển thị modal xác nhận!');
        return;
      }
      confirmationMessage.textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      modal.show();
      const confirmButton = document.getElementById('confirmButton');
      const newButton = confirmButton.cloneNode(true);
      confirmButton.parentNode.replaceChild(newButton, confirmButton);
      newButton.addEventListener('click', () => {
        callback();
        modal.hide();
      });
    };

    const updateLatestInventory = () => {
      if (!DOM.latestInventory) {
        showOutput('Lỗi hiển thị cập nhật mới nhất!');
        return;
      }
      if (!inventoryManager.latestCode) {
        DOM.latestInventory.innerHTML = '<tr><td colspan="3" class="text-center">Chưa có giao dịch</td></tr>';
        return;
      }
      const stockLines = inventoryManager.inventory.filter(line => line.code === inventoryManager.latestCode);
      const totalTrees = stockLines.reduce((sum, line) => sum + line.trees, 0);
      const totalMeters = stockLines.reduce((sum, line) => sum + line.meters, 0);
      DOM.latestInventory.innerHTML = `
        <tr>
          <td>${inventoryManager.latestCode}</td>
          <td>${formatNumber(totalTrees, 0)}</td>
          <td>${formatNumber(totalMeters)} m</td>
        </tr>`;
    };

    const updateInventoryTable = () => {
      if (!DOM.inventoryTable || !DOM.totalTrees || !DOM.totalMeters) {
        showOutput('Lỗi hiển thị bảng tồn kho!');
        return;
      }
      const filteredInventory = inventoryManager.getFilteredInventory();
      let totalTrees = 0;
      let totalMeters = 0;
      filteredInventory.forEach(line => {
        totalTrees += line.trees;
        totalMeters += line.meters;
      });

      DOM.inventoryTable.innerHTML = filteredInventory.length === 0
        ? '<tr><td colspan="4" class="text-center">Chưa có tồn kho</td></tr>'
        : filteredInventory.map(line => `
            <tr>
              <td>${line.code}</td>
              <td>${formatNumber(line.trees, 0)}</td>
              <td>${formatNumber(line.meters)} m</td>
              <td>
                <button class="btn btn-warning btn-sm action-btn" onclick='transferToInputTab(${JSON.stringify(line)})' ${line.trees === 0 && line.meters === 0 ? 'disabled' : ''}>Xuất</button>
              </td>
            </tr>`).join('');

      DOM.totalTrees.textContent = formatNumber(totalTrees, 0);
      DOM.totalMeters.textContent = `${formatNumber(totalMeters)} m`;
    };

    const updateInventoryFilters = () => {
      if (!DOM.filterFabricType || !DOM.filterColor) return;
      const fabricTypes = inventoryManager.getFabricTypes();
      const colors = inventoryManager.getColors();
      DOM.filterFabricType.innerHTML = '<option value="">Tất cả loại vải</option>' +
        fabricTypes.map(type => `<option value="${type}">${type}</option>`).join('');
      DOM.filterColor.innerHTML = '<option value="">Tất cả màu</option>' +
        colors.map(color => `<option value="${color}">${color}</option>`).join('');
    };

    const updateHistoryTable = () => {
      if (!DOM.transactions) {
        showOutput('Lỗi hiển thị lịch sử giao dịch!');
        return;
      }
      const filteredTransactions = inventoryManager.getFilteredTransactions();
      const totalPages = Math.max(1, Math.ceil(filteredTransactions.length / inventoryManager.itemsPerPage));
      inventoryManager.currentPage = Math.min(inventoryManager.currentPage, totalPages);
      const start = (inventoryManager.currentPage - 1) * inventoryManager.itemsPerPage;
      const pageTransactions = filteredTransactions.slice(start, start + inventoryManager.itemsPerPage);

      DOM.transactions.innerHTML = pageTransactions.length === 0
        ? '<tr><td colspan="8" class="text-center">Không có giao dịch</td></tr>'
        : pageTransactions.map((t, index) => {
            const globalIndex = start + index;
            return `
              <tr>
                <td>${t.date}</td>
                <td>${t.displayType}</td>
                <td>${t.code}</td>
                <td>${t.trees}</td>
                <td>${t.meters.toFixed(1)} m</td>
                <td>${t.stockTrees}</td>
                <td>${t.stockMeters.toFixed(1)} m</td>
                <td>
                  <button class="btn btn-warning btn-sm action-btn" onclick="editTransaction(${globalIndex})">Sửa</button>
                  <button class="btn btn-danger btn-sm action-btn" onclick="deleteTransaction(${globalIndex})">Xóa</button>
                </td>
              </tr>`;
          }).join('');

      if (DOM.pageInfo) DOM.pageInfo.textContent = `Trang ${inventoryManager.currentPage}/${totalPages}`;
      if (DOM.prevPageButton) DOM.prevPageButton.disabled = inventoryManager.currentPage === 1;
      if (DOM.nextPageButton) DOM.nextPageButton.disabled = inventoryManager.currentPage === totalPages;
    };

    const updateFilterDropdown = () => {
      if (!DOM.filterCode) return;
      const codes = [...new Set(inventoryManager.transactions.map(t => t.code))].sort();
      DOM.filterCode.innerHTML = '<option value="">Tất cả mã</option>' + codes.map(code => `<option value="${code}">${code}</option>`).join('');
    };

    const updateUI = () => {
      updateLatestInventory();
      updateInventoryTable();
      updateInventoryFilters();
      updateHistoryTable();
      updateFilterDropdown();
    };

    const processFormCommand = () => {
      const type = document.getElementById('formType')?.value;
      const code = document.getElementById('formCode')?.value.trim().toUpperCase();
      const trees = parseInt(document.getElementById('formTrees')?.value);
      const meters = parseFloat(document.getElementById('formMeters')?.value);
      const date = document.getElementById('formDate')?.value || inventoryManager.today;

      if (!type || !code || isNaN(trees) || isNaN(meters)) {
        showOutput('Vui lòng nhập đầy đủ thông tin!');
        return;
      }

      const error = inventoryManager.validateTransaction(code, trees, meters);
      if (error) {
        showOutput(error);
        return;
      }

      const formattedCode = code.slice(0, 3) + '-' + code.slice(3);
      const formattedMeters = parseFloat(meters.toFixed(1));
      const formattedDate = inventoryManager.formatDate(date);

      const message = inventoryManager.editingIndex !== null
        ? `Xác nhận cập nhật giao dịch mã ${formattedCode} với ${type === 'n' ? 'nhập' : 'xuất'} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}?`
        : `Xác nhận ${type === 'n' ? 'nhập' : 'xuất'} mã ${formattedCode} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}?`;

      showConfirmation(message, () => {
        let result;
        if (inventoryManager.editingIndex !== null) {
          result = inventoryManager.editTransaction(inventoryManager.editingIndex, type, code, trees, meters, date);
          inventoryManager.editingIndex = null;
        } else {
          result = inventoryManager.addTransaction(type, code, trees, meters, date);
        }

        if (!result.success) {
          showOutput(result.error);
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã cập nhật thành công!');
        document.getElementById('formCode').value = '';
        document.getElementById('formTrees').value = '0';
        document.getElementById('formMeters').value = '0.0';
      });
    };

    const editTransaction = (index) => {
      const transaction = inventoryManager.transactions[index];
      if (!transaction) {
        showOutput('Lỗi truy cập giao dịch!');
        return;
      }
      const inputTab = document.getElementById('input-tab');
      const formType = document.getElementById('formType');
      const formCode = document.getElementById('formCode');
      const formTrees = document.getElementById('formTrees');
      const formMeters = document.getElementById('formMeters');
      const formDate = document.getElementById('formDate');
      if (!inputTab || !formType || !formCode || !formTrees || !formMeters || !formDate) {
        showOutput('Lỗi điền form nhập liệu!');
        return;
      }

      inventoryManager.editingIndex = index;
      formType.value = transaction.type;
      formCode.value = transaction.code.replace('-', '');
      formTrees.value = transaction.trees;
      formMeters.value = transaction.meters.toFixed(1);
      formDate.value = transaction.date.split('/').reverse().join('-');

      const tab = new bootstrap.Tab(inputTab);
      tab.show();
    };

    const deleteTransaction = (index) => {
      const transaction = inventoryManager.transactions[index];
      if (!transaction) {
        showOutput('Lỗi truy cập giao dịch!');
        return;
      }

      showConfirmation(`Bạn có chắc chắn muốn xóa giao dịch ${transaction.displayType} mã ${transaction.code} ngày ${transaction.date}?`, () => {
        const result = inventoryManager.deleteTransaction(index);
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã xóa giao dịch thành công!');
      });
    };

    const exportInventory = () => {
      showConfirmation('Xác nhận xuất dữ liệu tồn kho ra file CSV?', () => {
        const result = inventoryManager.exportInventoryToCSV();
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        showOutput(`Đã xuất dữ liệu thành công: ${result.fileName}`);
      });
    };

    const exportTransactions = () => {
      showConfirmation('Xác nhận xuất lịch sử giao dịch ra file CSV?', () => {
        const result = inventoryManager.exportTransactionsToCSV();
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        showOutput(`Đã xuất dữ liệu thành công: ${result.fileName}`);
      });
    };

    const importInventory = async () => {
      const fileInput = document.getElementById('importInventoryFile');
      if (!fileInput || !fileInput.files[0]) {
        showOutput('Vui lòng chọn file!');
        return;
      }
      const file = fileInput.files[0];
      showConfirmation('Xác nhận nhập dữ liệu tồn kho từ file đã chọn?', async () => {
        const result = await inventoryManager.importInventory(file);
        if (!result.success) {
          showOutput(result.error);
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã nhập dữ liệu thành công!');
        fileInput.value = '';
        document.getElementById('importInventoryButton').disabled = true;
      });
    };

    const deleteAllTransactions = () => {
      showConfirmation('Xác nhận xóa toàn bộ lịch sử giao dịch? Hành động này không thể hoàn tác.', () => {
        const result = inventoryManager.deleteAllTransactions();
        if (!result.success) {
          showOutput('Lỗi xóa lịch sử giao dịch!');
          return;
        }
        if (!inventoryManager.saveData()) {
          showOutput('Lỗi lưu dữ liệu!');
          return;
        }
        updateUI();
        showOutput('Đã xóa toàn bộ lịch sử giao dịch!');
      });
    };

    const applyFilter = debounce(() => {
      const filterCode = document.getElementById('filterCode')?.value;
      const filterStartDate = document.getElementById('filterStartDate')?.value;
      const filterEndDate = document.getElementById('filterEndDate')?.value;
      inventoryManager.currentFilter = {
        code: filterCode || '',
        startDate: filterStartDate || '',
        endDate: filterEndDate || ''
      };
      inventoryManager.currentPage = 1;
      updateUI();
    }, 300);

    const applyInventoryFilter = debounce(() => {
      const filterFabricType = document.getElementById('filterFabricType')?.value;
      const filterColor = document.getElementById('filterColor')?.value;
      inventoryManager.filterInventory = {
        fabricType: filterFabricType || '',
        color: filterColor || ''
      };
      updateUI();
    }, 300);

    const prevPage = () => {
      if (inventoryManager.currentPage > 1) {
        inventoryManager.currentPage--;
        updateUI();
      }
    };

    const nextPage = () => {
      const filteredTransactions = inventoryManager.getFilteredTransactions();
      const totalPages = Math.max(1, Math.ceil(filteredTransactions.length / inventoryManager.itemsPerPage));
      if (inventoryManager.currentPage < totalPages) {
        inventoryManager.currentPage++;
        updateUI();
      }
    };

    const transferToInputTab = (line) => {
      if (!line || !line.code) {
        showOutput('Lỗi truy cập dòng tồn kho!');
        return;
      }
      const inputTab = document.getElementById('input-tab');
      const formType = document.getElementById('formType');
      const formCode = document.getElementById('formCode');
      const formTrees = document.getElementById('formTrees');
      const formMeters = document.getElementById('formMeters');
      const formDate = document.getElementById('formDate');
      if (!inputTab || !formType || !formCode || !formTrees || !formMeters || !formDate) {
        showOutput('Lỗi điền form nhập liệu!');
        return;
      }

      formType.value = 'x';
      formCode.value = line.code.replace('-', '');
      formTrees.value = line.trees;
      formMeters.value = line.meters.toFixed(1);
      formDate.value = inventoryManager.today;

      const tab = new bootstrap.Tab(inputTab);
      tab.show();
    };

    document.getElementById('formDate').value = inventoryManager.today;
    document.getElementById('input-tab')?.addEventListener('shown.bs.tab', () => {
      document.getElementById('formCode')?.focus();
    });
    document.getElementById('processFormButton')?.addEventListener('click', processFormCommand);
    document.getElementById('applyFilterButton')?.addEventListener('click', applyFilter);
    document.getElementById('applyInventoryFilterButton')?.addEventListener('click', applyInventoryFilter);
    document.getElementById('prevPageButton')?.addEventListener('click', prevPage);
    document.getElementById('nextPageButton')?.addEventListener('click', nextPage);
    document.getElementById('exportInventoryButton')?.addEventListener('click', exportInventory);
    document.getElementById('exportTransactionsButton')?.addEventListener('click', exportTransactions);
    document.getElementById('importInventoryButton')?.addEventListener('click', importInventory);
    document.getElementById('deleteAllTransactionsButton')?.addEventListener('click', deleteAllTransactions);
    document.getElementById('importInventoryFile')?.addEventListener('change', () => {
      const importButton = document.getElementById('importInventoryButton');
      if (importButton) importButton.disabled = !document.getElementById('importInventoryFile').files[0];
    });

    inventoryManager.loadData();
    updateUI();
  </script>
</body>
</html>
