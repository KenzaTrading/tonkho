<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý kho vải</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 15px; background-color: #f4f7fa; }
    .container { max-width: 800px; margin: auto; }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .nav-tabs { border-bottom: 2px solid #e0e7ff; }
    .nav-link { color: #495057; font-weight: 500; padding: 10px 20px; }
    .nav-link.active { background-color: #e0e7ff; color: #0d6efd; border-radius: 8px 8px 0 0; }
    .tab-content { padding: 20px; background: #fff; border-radius: 0 0 10px 10px; }
    #output { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px; font-size: 0.9em; }
    .table { margin-top: 15px; font-size: 0.9em; }
    .table th, .table td { vertical-align: middle; }
    .btn { border-radius: 5px; font-size: 0.9em; padding: 8px 15px; }
    .form-control, .form-select { font-size: 0.9em; border-radius: 5px; }
    .form-section, .filter-section { margin-bottom: 20px; }
    .action-btn { padding: 5px 10px; font-size: 0.8em; }
    .pagination-section { margin-top: 15px; text-align: center; }
    .pagination-btn { margin: 0 5px; }
    .manage-data-btns { display: flex; gap: 10px; align-items: center; }
    @media (max-width: 576px) {
      body { padding: 10px; }
      .nav-link { padding: 8px 15px; font-size: 0.9em; }
      .tab-content { padding: 15px; }
      .btn { width: 100%; margin-bottom: 10px; }
      .form-section h5, .filter-section h5 { font-size: 1em; }
      .table { font-size: 0.8em; }
      .row.g-3 > div { margin-bottom: 10px; }
      .filter-section .col-12, .filter-section .col-md-2 { margin-bottom: 10px; }
      .pagination-btn { padding: 6px 12px; font-size: 0.8em; }
      .manage-data-btns { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4" style="font-size: 1.5em; color: #0d6efd;">Quản lý kho vải</h1>

    <div class="card">
      <!-- Nav tabs -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input" type="button" role="tab" aria-controls="input" aria-selected="true">Nhập liệu</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory-tab-content" type="button" role="tab" aria-controls="inventory-tab-content" aria-selected="false">Tồn kho</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">Lịch sử giao dịch</button>
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content" id="myTabContent">
        <!-- Tab 1: Nhập liệu -->
        <div class="tab-pane fade show active" id="input" role="tabpanel" aria-labelledby="input-tab">
          <!-- Form nhập liệu -->
          <div class="form-section">
            <h5>Nhập liệu</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="formType" class="form-label">Loại lệnh:</label>
                <select class="form-select" id="formType">
                  <option value="t">Tồn</option>
                  <option value="n">Nhập</option>
                  <option value="x">Xuất</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="formCode" class="form-label">Mã vải:</label>
                <input type="text" class="form-control" id="formCode" placeholder="VD: A01">
              </div>
              <div class="col-md-2 col-12">
                <label for="formTrees" class="form-label">Số cây:</label>
                <input type="number" min="0" step="1" class="form-control" id="formTrees" placeholder="VD: 3">
              </div>
              <div class="col-md-2 col-12">
                <label for="formMeters" class="form-label">Số mét:</label>
                <input type="number" step="0.1" class="form-control" id="formMeters" placeholder="VD: 100.5">
              </div>
              <div class="col-md-2 col-12">
                <label for="formDate" class="form-label">Ngày:</label>
                <input type="date" class="form-control" id="formDate" value="">
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="processFormCommand()">Thực hiện</button>
          </div>

          <div id="output" class="text-center">Kết quả sẽ hiển thị ở đây...</div>

          <h2 class="mt-4" style="font-size: 1.2em;">Cập nhật 5 mã gần đây nhất</h2>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Mã vải</th>
                <th>Số cây</th>
                <th>Số mét</th>
              </tr>
            </thead>
            <tbody id="recent-inventory"></tbody>
          </table>
        </div>

        <!-- Tab 2: Tồn kho -->
        <div class="tab-pane fade" id="inventory-tab-content" role="tabpanel" aria-labelledby="inventory-tab">
          <div class="form-section">
            <h5>Tìm kiếm tồn kho</h5>
            <div class="row g-3">
              <div class="col-md-6 col-12">
                <label for="searchCode" class="form-label">Chọn mã vải:</label>
                <select class="form-select" id="searchCode">
                  <option value="">Tất cả mã</option>
                </select>
              </div>
              <div class="col-md-6 col-12 d-flex align-items-end gap-2">
                <button class="btn btn-secondary" onclick="clearSearch()">Xóa bộ lọc</button>
                <button class="btn btn-primary" onclick="exportInventory()">Xuất tồn kho</button>
              </div>
            </div>
          </div>
          <h2 class="mt-2" style="font-size: 1.2em;">Tồn kho</h2>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Mã vải</th>
                <th>Số cây</th>
                <th>Số mét</th>
              </tr>
            </thead>
            <tbody id="inventory"></tbody>
          </table>
        </div>

        <!-- Tab 3 Lịch sử giao dịch -->
        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
          <div class="filter-section">
            <h5>Lọc giao dịch</h5>
            <div class="row g-3">
              <div class="col-md-4 col-12">
                <label for="filterCode" class="form-label">Mã vải:</label>
                <select class="form-select" id="filterCode">
                  <option value="">Tất cả mã</option>
                </select>
              </div>
              <div class="col-md-4 col-12">
                <label for="filterStartDate" class="form-label">Từ ngày:</label>
                <input type="date" class="form-control" id="filterStartDate">
              </div>
              <div class="col-md-4 col-12">
                <label for="filterEndDate" class="form-label">Đến ngày:</label>
                <input type="date" class="form-control" id="filterEndDate">
                <div class="d-flex align-items-end mt-2">
                  <button class="btn btn-primary btn-sm" onclick="applyFilter()">Thực hiện</button>
                </div>
              </div>
            </div>
          </div>
          <div class="form-section">
            <h5>Quản lý dữ liệu</h5>
            <div class="row g-3">
              <div class="col-md-6 col-12">
                <label for="importFile" class="form-label">Import dữ liệu (CSV):</label>
                <input type="file" class="form-control" id="importFile" accept=".csv">
              </div>
              <div class="col-md-6 col-12 d-flex align-items-end">
                <div class="manage-data-btns">
                  <button class="btn btn-primary" onclick="exportData()">Xuất dữ liệu</button>
                  <button class="btn btn-danger" onclick="showClearAllConfirmation()">Xóa toàn bộ</button>
                </div>
              </div>
            </div>
          </div>
          <h2 class="mt-2" style="font-size: 1.2em;">Lịch sử giao dịch</h2>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Ngày</th>
                <th>Loại</th>
                <th>Mã vải</th>
                <th>Số cây</th>
                <th>Số mét</th>
                <th>Tồn kho (cây)</th>
                <th>Tồn kho (mét)</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="transactions"></tbody>
          </table>
          <div class="pagination-section">
            <button class="btn btn-outline-primary pagination-btn" onclick="prevPage()" id="prevPage" disabled>Trước</button>
            <span id="pageInfo">Trang 1/1</span>
            <button class="btn btn-outline-primary pagination-btn" onclick="nextPage()" id="nextPage" disabled>Sau</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal xác nhận -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">Xác nhận lệnh</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmationMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="confirmButton">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal xác nhận xóa toàn bộ -->
  <div class="modal fade" id="clearAllModal" tabindex="-1" aria-labelledby="clearAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="clearAllModalLabel">Xác nhận xóa toàn bộ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">Bạn có chắc muốn xóa toàn bộ dữ liệu? Hành động này không thể hoàn tác.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-danger" onclick="clearAllData()">Xóa</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal chỉnh sửa -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Chỉnh sửa giao dịch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editType" class="form-label">Loại lệnh:</label>
            <select class="form-select" id="editType">
              <option value="t">Tồn</option>
              <option value="n">Nhập</option>
              <option value="x">Xuất</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editCode" class="form-label">Mã vải:</label>
            <input type="text" class="form-control" id="editCode">
          </div>
          <div class="mb-3">
            <label for="editTrees" class="form-label">Số cây:</label>
            <input type="number" min="0" step="1" class="form-control" id="editTrees">
          </div>
          <div class="mb-3">
            <label for="editMeters" class="form-label">Số mét:</label>
            <input type="number" step="0.1" class="form-control" id="editMeters">
          </div>
          <div class="mb-3">
            <label for="editDate" class="form-label">Ngày:</label>
            <input type="date" class="form-control" id="editDate">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="saveEditButton">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Dữ liệu kho
    let inventory = {};
    let transactions = [];
    let pendingCommand = null;
    let editingIndex = null;
    let currentFilter = { code: '', startDate: '', endDate: '' };
    let currentPage = 1;
    const itemsPerPage = 10;

    // Thiết lập ngày mặc định là hôm nay
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('formDate').value = today;

    // Hàm lưu dữ liệu vào localStorage
    function saveData() {
      try {
        localStorage.setItem('inventory', JSON.stringify(inventory));
        localStorage.setItem('transactions', JSON.stringify(transactions));
      } catch (error) {
        console.error('Lỗi lưu localStorage:', error);
        document.getElementById('output').textContent = 'Lỗi lưu dữ liệu!';
      }
    }

    // Hàm tải dữ liệu từ localStorage
    function loadData() {
      try {
        inventory = JSON.parse(localStorage.getItem('inventory') || '{}');
        transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        updateUI();
      } catch (error) {
        console.error('Lỗi tải localStorage:', error);
        document.getElementById('output').textContent = 'Lỗi tải dữ liệu!';
      }
    }

    // Hàm tính toán lại tồn kho từ lịch sử giao dịch
    function recalculateInventory() {
      inventory = {};
      transactions.forEach(t => {
        if (t && t.type && t.code && t.trees !== undefined && t.meters !== undefined) {
          if (t.type === 't') {
            inventory[t.code] = { trees: t.trees, meters: t.meters };
          } else if (t.type === 'n') {
            inventory[t.code] = inventory[t.code] || { trees: 0, meters: 0 };
            inventory[t.code].trees += t.trees;
            inventory[t.code].meters += t.meters;
          } else if (t.type === 'x') {
            inventory[t.code] = inventory[t.code] || { trees: 0, meters: 0 };
            inventory[t.code].trees -= t.trees;
            inventory[t.code].meters -= t.meters;
          }
        }
      });
    }

    // Cập nhật giao diện
    function updateUI() {
      // Cập nhật 5 mã gần đây nhất
      const recentInventoryBody = document.getElementById('recent-inventory');
      recentInventoryBody.innerHTML = '';
      const recentCodes = [...new Set(transactions.map(t => t.code))]
        .slice(0, 5)
        .filter(code => inventory[code]);
      recentCodes.forEach(code => {
        const data = inventory[code];
        const row = `<tr><td>${code}</td><td>${data.trees}</td><td>${data.meters.toFixed(1)} m</td></tr>`;
        recentInventoryBody.innerHTML += row;
      });

      // Cập nhật tồn kho
      const inventoryBody = document.getElementById('inventory');
      inventoryBody.innerHTML = '';
      const searchCode = document.getElementById('searchCode').value;
      let codes = Object.keys(inventory).sort();
      if (searchCode) {
        codes = codes.filter(code => code === searchCode);
      }
      codes.forEach(code => {
        const data = inventory[code];
        const row = `<tr><td>${code}</td><td>${data.trees}</td><td>${data.meters.toFixed(1)} m</td></tr>`;
        inventoryBody.innerHTML += row;
      });

      // Cập nhật dropdown tìm kiếm
      const searchSelect = document.getElementById('searchCode');
      const filterSelect = document.getElementById('filterCode');
      const existingCodes = [...new Set(transactions.map(t => t.code))].sort();
      searchSelect.innerHTML = '<option value="">Tất cả mã</option>';
      filterSelect.innerHTML = '<option value="">Tất cả mã</option>';
      existingCodes.forEach(code => {
        searchSelect.innerHTML += `<option value="${code}">${code}</option>`;
        filterSelect.innerHTML += `<option value="${code}">${code}</option>`;
      });

      // Cập nhật lịch sử giao dịch (phân trang)
      const transactionsBody = document.getElementById('transactions');
      transactionsBody.innerHTML = '';
      const filteredTransactions = transactions.filter(t => {
        if (!t || !t.date || !t.code) return false;
        const date = new Date(t.date.split('/').reverse().join('-'));
        const startDate = currentFilter.startDate ? new Date(currentFilter.startDate) : null;
        const endDate = currentFilter.endDate ? new Date(currentFilter.endDate) : null;
        return (
          (!currentFilter.code || t.code === currentFilter.code) &&
          (!startDate || date >= startDate) &&
          (!endDate || date <= endDate)
        );
      });
      const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
      currentPage = Math.min(currentPage, totalPages || 1);
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageTransactions = filteredTransactions.slice(start, end);
      pageTransactions.forEach((t, index) => {
        if (t && t.date && t.displayType && t.code && t.trees !== undefined && t.meters !== undefined && t.stockTrees !== undefined && t.stockMeters !== undefined) {
          const globalIndex = start + index;
          const row = `
            <tr>
              <td>${t.date}</td>
              <td>${t.displayType}</td>
              <td>${t.code}</td>
              <td>${t.trees}</td>
              <td>${t.meters.toFixed(1)} m</td>
              <td>${t.stockTrees}</td>
              <td>${t.stockMeters.toFixed(1)} m</td>
              <td>
                <button class="btn btn-sm btn-warning action-btn" onclick="editTransaction(${globalIndex})">Sửa</button>
                <button class="btn btn-sm btn-danger action-btn" onclick="deleteTransaction(${globalIndex})">Xóa</button>
              </td>
            </tr>`;
          transactionsBody.innerHTML += row;
        }
      });

      // Cập nhật phân trang
      document.getElementById('pageInfo').textContent = `Trang ${currentPage}/${totalPages || 1}`;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
    }

    // Xử lý lệnh từ form
    function processFormCommand() {
      const type = document.getElementById('formType').value;
      const code = document.getElementById('formCode').value.trim().toUpperCase();
      const trees = parseInt(document.getElementById('formTrees').value);
      const meters = parseFloat(document.getElementById('formMeters').value);
      const date = document.getElementById('formDate').value || today;
      
      if (!code || isNaN(trees) || trees < 0 || isNaN(meters) || meters <= 0) {
        document.getElementById('output').textContent = 'Vui lòng nhập đầy đủ mã vải, số cây và số mét hợp lệ!';
        return;
      }

      // Kiểm tra số mét có đúng 1 chữ số thập phân
      const metersStr = meters.toString();
      const decimalPart = metersStr.split('.')[1];
      if (decimalPart && decimalPart.length > 1) {
        document.getElementById('output').textContent = 'Số mét chỉ được có 1 chữ số thập phân!';
        return;
      }

      const formattedMeters = parseFloat(meters.toFixed(1));
      const formattedDate = new Date(date).toLocaleDateString('vi-VN');
      let stockTrees = trees;
      let stockMeters = formattedMeters;

      if (type === 'n') {
        stockTrees = (inventory[code]?.trees || 0) + trees;
        stockMeters = (inventory[code]?.meters || 0) + formattedMeters;
      } else if (type === 'x') {
        if ((inventory[code]?.trees || 0) < trees || (inventory[code]?.meters || 0) < formattedMeters) {
          document.getElementById('output').textContent = `Lỗi: Không đủ tồn kho mã ${code}. Tồn kho hiện tại: ${inventory[code]?.trees || 0} cây, ${(inventory[code]?.meters || 0).toFixed(1)} mét.`;
          return;
        }
        stockTrees = (inventory[code]?.trees || 0) - trees;
        stockMeters = (inventory[code]?.meters || 0) - formattedMeters;
      }

      const displayType = type === 't' ? 'tồn' : type === 'n' ? 'nhập' : 'xuất';
      pendingCommand = { date: formattedDate, type, displayType, code, trees, meters: formattedMeters, stockTrees, stockMeters };
      
      showConfirmation(`Xác nhận ${displayType} mã ${code} ${trees} cây, ${formattedMeters.toFixed(1)} mét vào ngày ${formattedDate}? Tồn kho sẽ là ${stockTrees} cây, ${stockMeters.toFixed(1)} mét.`);
      
      document.getElementById('formCode').value = '';
      document.getElementById('formTrees').value = '';
      document.getElementById('formMeters').value = '';
    }

    // Hiển thị popup xác nhận
    function showConfirmation(message) {
      document.getElementById('confirmationMessage').textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      modal.show();

      // Xử lý nút xác nhận
      document.getElementById('confirmButton').onclick = function() {
        if (pendingCommand) {
          inventory[pendingCommand.code] = { trees: pendingCommand.stockTrees, meters: pendingCommand.stockMeters };
          transactions.push(pendingCommand);
          saveData();
          updateUI();
          modal.hide();
          pendingCommand = null;
          document.getElementById('output').textContent = 'Đã cập nhật thành công!';
        }
      };
    }

    // Hiển thị popup xác nhận xóa toàn bộ
    function showClearAllConfirmation() {
      const modal = new bootstrap.Modal(document.getElementById('clearAllModal'));
      modal.show();
    }

    // Xóa toàn bộ dữ liệu
    function clearAllData() {
      inventory = {};
      transactions = [];
      currentPage = 1;
      saveData();
      updateUI();
      bootstrap.Modal.getInstance(document.getElementById('clearAllModal')).hide();
      document.getElementById('output').textContent = 'Đã xóa toàn bộ dữ liệu!';
    }

    // Xóa giao dịch
    function deleteTransaction(index) {
      if (confirm('Bạn có chắc muốn xóa giao dịch này?')) {
        transactions.splice(index, 1);
        recalculateInventory();
        saveData();
        updateUI();
        document.getElementById('output').textContent = 'Đã xóa giao dịch!';
      }
    }

    // Chỉnh sửa giao dịch
    function editTransaction(index) {
      editingIndex = index;
      const t = transactions[index];
      if (!t) return;
      document.getElementById('editType').value = t.type;
      document.getElementById('editCode').value = t.code;
      document.getElementById('editTrees').value = t.trees;
      document.getElementById('editMeters').value = t.meters.toFixed(1);
      // Chuyển định dạng ngày DD/MM/YYYY sang YYYY-MM-DD
      const [day, month, year] = t.date.split('/');
      document.getElementById('editDate').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    }

    // Lưu giao dịch đã chỉnh sửa
    document.getElementById('saveEditButton').onclick = function() {
      const type = document.getElementById('editType').value;
      const code = document.getElementById('editCode').value.trim().toUpperCase();
      const trees = parseInt(document.getElementById('editTrees').value);
      const meters = parseFloat(document.getElementById('editMeters').value);
      const date = document.getElementById('editDate').value;

      if (!code || isNaN(trees) || trees < 0 || isNaN(meters) || meters <= 0) {
        document.getElementById('output').textContent = 'Vui lòng nhập đầy đủ mã vải, số cây và số mét hợp lệ!';
        return;
      }

      // Kiểm tra số mét có đúng 1 chữ số thập phân
      const metersStr = meters.toString();
      const decimalPart = metersStr.split('.')[1];
      if (decimalPart && decimalPart.length > 1) {
        document.getElementById('output').textContent = 'Số mét chỉ được có 1 chữ số thập phân!';
        return;
      }

      const formattedMeters = parseFloat(meters.toFixed(1));
      const formattedDate = new Date(date).toLocaleDateString('vi-VN');
      const displayType = type === 't' ? 'tồn' : type === 'n' ? 'nhập' : 'xuất';
      let stockTrees = trees;
      let stockMeters = formattedMeters;

      if (type === 'n') {
        stockTrees = (inventory[code]?.trees || 0) + trees - (transactions[editingIndex].type === 'n' ? transactions[editingIndex].trees : 0);
        stockMeters = (inventory[code]?.meters || 0) + formattedMeters - (transactions[editingIndex].type === 'n' ? transactions[editingIndex].meters : 0);
      } else if (type === 'x') {
        stockTrees = (inventory[code]?.trees || 0) - trees + (transactions[editingIndex].type === 'x' ? transactions[editingIndex].trees : 0);
        stockMeters = (inventory[code]?.meters || 0) - formattedMeters + (transactions[editingIndex].type === 'x' ? transactions[editingIndex].meters : 0);
      }

      transactions[editingIndex] = { date: formattedDate, type, displayType, code, trees, meters: formattedMeters, stockTrees, stockMeters };
      recalculateInventory();
      saveData();
      updateUI();
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      document.getElementById('output').textContent = 'Đã chỉnh sửa giao dịch!';
      editingIndex = null;
    };

    // Xử lý tìm kiếm tồn kho
    document.getElementById('searchCode').onchange = function() {
      updateUI();
    };

    // Xóa bộ lọc tìm kiếm
    function clearSearch() {
      document.getElementById('searchCode').value = '';
      updateUI();
    }

    // Áp dụng bộ lọc lịch sử
    function applyFilter() {
      currentFilter.code = document.getElementById('filterCode').value;
      currentFilter.startDate = document.getElementById('filterStartDate').value;
      currentFilter.endDate = document.getElementById('filterEndDate').value;
      currentPage = 1;
      updateUI();
    }

    // Chuyển trang trước
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        updateUI();
      }
    }

    // Chuyển trang sau
    function nextPage() {
      const filteredTransactions = transactions.filter(t => {
        if (!t || !t.date || !t.code) return false;
        const date = new Date(t.date.split('/').reverse().join('-'));
        const startDate = currentFilter.startDate ? new Date(currentFilter.startDate) : null;
        const endDate = currentFilter.endDate ? new Date(currentFilter.endDate) : null;
        return (
          (!currentFilter.code || t.code === currentFilter.code) &&
          (!startDate || date >= startDate) &&
          (!endDate || date <= endDate)
        );
      });
      const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updateUI();
      }
    }

    // Xuất dữ liệu lịch sử giao dịch (CSV)
    function exportData() {
      const headers = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét', 'Tồn kho (cây)', 'Tồn kho (mét)'];
      const rows = transactions.map(t => [
        t.date,
        t.displayType,
        t.code,
        t.trees,
        t.meters.toFixed(1),
        t.stockTrees,
        t.stockMeters.toFixed(1)
      ]);
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
      a.href = url;
      a.download = `tonkho_lichsu_${date}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      document.getElementById('output').textContent = 'Đã xuất dữ liệu!';
    }

    // Xuất dữ liệu tồn kho (CSV)
    function exportInventory() {
      const headers = ['Ngày', 'Loại', 'Mã vải', 'Số cây', 'Số mét', 'Tồn kho (cây)', 'Tồn kho (mét)'];
      const rows = [];
      Object.keys(inventory).sort().forEach(code => {
        const data = inventory[code];
        // Lấy giao dịch cuối cùng của mã vải
        const lastTransaction = [...transactions]
          .reverse()
          .find(t => t.code === code) || {
            date: new Date().toLocaleDateString('vi-VN'),
            displayType: 'tồn',
            type: 't'
          };
        rows.push([
          lastTransaction.date,
          lastTransaction.displayType,
          code,
          data.trees,
          data.meters.toFixed(1),
          data.trees,
          data.meters.toFixed(1)
        ]);
      });
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
      a.href = url;
      a.download = `tonkho_${date}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      document.getElementById('output').textContent = 'Đã xuất tồn kho!';
    }

    // Import dữ liệu (CSV)
    document.getElementById('importFile').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!file.name.endsWith('.csv')) {
        document.getElementById('output').textContent = 'Vui lòng chọn file CSV!';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n').map(line => line.split(','));
          if (lines.length < 1 || lines[0].length < 7 || lines[0][0] !== 'Ngày') {
            document.getElementById('output').textContent = 'File CSV không hợp lệ!';
            return;
          }
          const newTransactions = [];
          for (let i = 1; i < lines.length; i++) {
            const [date, displayType, code, trees, meters, stockTrees, stockMeters] = lines[i];
            if (date && displayType && code && trees && meters && stockTrees && stockMeters) {
              const type = displayType === 'tồn' ? 't' : displayType === 'nhập' ? 'n' : 'x';
              newTransactions.push({
                date,
                type,
                displayType,
                code,
                trees: parseInt(trees),
                meters: parseFloat(meters),
                stockTrees: parseInt(stockTrees),
                stockMeters: parseFloat(stockMeters)
              });
            }
          }
          if (newTransactions.length === 0) {
            document.getElementById('output').textContent = 'File CSV không chứa dữ liệu hợp lệ!';
            return;
          }
          if (confirm('Import sẽ ghi đè dữ liệu hiện tại. Bạn có chắc muốn tiếp tục?')) {
            transactions = newTransactions;
            recalculateInventory();
            currentPage = 1;
            saveData();
            updateUI();
            document.getElementById('output').textContent = 'Đã import dữ liệu thành công!';
            event.target.value = '';
          }
        } catch (error) {
          document.getElementById('output').textContent = 'Lỗi đọc file CSV!';
          console.error('Lỗi import:', error);
        }
      };
      reader.readAsText(file);
    });

    // Tải dữ liệu khi khởi động
    loadData();
  </script>
</body>
</html>
