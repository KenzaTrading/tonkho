<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý kho vải</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 15px; background-color: #f4f7fa; }
    .container { max-width: 800px; margin: auto; }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .nav-tabs { border-bottom: 2px solid #e0e7ff; }
    .nav-link { color: #495057; font-weight: 500; padding: 10px 20px; }
    .nav-link.active { background-color: #e0e7ff; color: #0d6efd; border-radius: 8px 8px 0 0; }
    .tab-content { padding: 20px; background: #fff; border-radius: 0 0 10px 10px; }
    #output { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px; font-size: 0.9em; }
    .table { margin-top: 15px; font-size: 0.9em; }
    .table th, .table td { vertical-align: middle; }
    .btn { border-radius: 5px; font-size: 0.9em; padding: 8px 15px; }
    .form-control, .form-select { font-size: 0.9em; border-radius: 5px; }
    .form-section { margin-bottom: 20px; }
    .action-btn { padding: 5px 10px; font-size: 0.8em; }
    @media (max-width: 576px) {
      body { padding: 10px; }
      .nav-link { padding: 8px 15px; font-size: 0.9em; }
      .tab-content { padding: 15px; }
      .btn { width: 100%; margin-bottom: 10px; }
      .form-section h5 { font-size: 1em; }
      .table { font-size: 0.8em; }
      .row.g-3 > div { margin-bottom: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4" style="font-size: 1.5em; color: #0d6efd;">Quản lý kho vải</h1>

    <div class="card">
      <!-- Nav tabs -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input" type="button" role="tab" aria-controls="input" aria-selected="true">Nhập liệu & Tồn kho</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">Lịch sử giao dịch</button>
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content" id="myTabContent">
        <!-- Tab 1: Nhập liệu & Tồn kho -->
        <div class="tab-pane fade show active" id="input" role="tabpanel" aria-labelledby="input-tab">
          <!-- Nhập lệnh text -->
          <div class="form-section">
            <h5>Nhập lệnh text</h5>
            <div class="mb-3">
              <label for="commandInput" class="form-label">Lệnh (VD: t a01 100, n a01 50m, x a01 30):</label>
              <div class="input-group">
                <input type="text" class="form-control" id="commandInput" placeholder="Nhập lệnh tại đây">
                <button class="btn btn-primary" onclick="processTextCommand()">Thực hiện</button>
              </div>
            </div>
            <div class="mb-3">
              <label for="commandDate" class="form-label">Ngày:</label>
              <input type="date" class="form-control" id="commandDate" value="">
            </div>
          </div>

          <!-- Form nhập liệu -->
          <div class="form-section">
            <h5>Nhập liệu qua form</h5>
            <div class="row g-3">
              <div class="col-md-3 col-12">
                <label for="formType" class="form-label">Loại lệnh:</label>
                <select class="form-select" id="formType">
                  <option value="t">Tồn</option>
                  <option value="n">Nhập</option>
                  <option value="x">Xuất</option>
                </select>
              </div>
              <div class="col-md-3 col-12">
                <label for="formCode" class="form-label">Mã vải:</label>
                <input type="text" class="form-control" id="formCode" placeholder="VD: A01">
              </div>
              <div class="col-md-3 col-12">
                <label for="formAmount" class="form-label">Số mét:</label>
                <input type="number" class="form-control" id="formAmount" placeholder="VD: 100">
              </div>
              <div class="col-md-3 col-12">
                <label for="formDate" class="form-label">Ngày:</label>
                <input type="date" class="form-control" id="formDate" value="">
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="processFormCommand()">Thực hiện</button>
          </div>

          <div id="output" class="text-center">Kết quả sẽ hiển thị ở đây...</div>

          <h2 class="mt-4" style="font-size: 1.2em;">Tồn kho hiện tại</h2>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Mã vải</th>
                <th>Số mét</th>
              </tr>
            </thead>
            <tbody id="inventory"></tbody>
          </table>
        </div>

        <!-- Tab 2: Lịch sử giao dịch -->
        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
          <h2 class="mt-2" style="font-size: 1.2em;">Lịch sử giao dịch</h2>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Ngày</th>
                <th>Loại</th>
                <th>Mã vải</th>
                <th>Số mét</th>
                <th>Tồn kho</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="transactions"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal xác nhận -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">Xác nhận lệnh</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmationMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="confirmButton">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal chỉnh sửa -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Chỉnh sửa giao dịch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editType" class="form-label">Loại lệnh:</label>
            <select class="form-select" id="editType">
              <option value="t">Tồn</option>
              <option value="n">Nhập</option>
              <option value="x">Xuất</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editCode" class="form-label">Mã vải:</label>
            <input type="text" class="form-control" id="editCode">
          </div>
          <div class="mb-3">
            <label for="editAmount" class="form-label">Số mét:</label>
            <input type="number" class="form-control" id="editAmount">
          </div>
          <div class="mb-3">
            <label for="editDate" class="form-label">Ngày:</label>
            <input type="date" class="form-control" id="editDate">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="saveEditButton">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Cấu hình Firebase (thay bằng cấu hình của bạn từ Firebase Console)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Dữ liệu kho
    let inventory = {};
    let transactions = [];
    let pendingCommand = null;
    let editingIndex = null;

    // Thiết lập ngày mặc định là hôm nay
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('commandDate').value = today;
    document.getElementById('formDate').value = today;

    // Hàm lưu dữ liệu vào Firebase
    function saveData() {
      database.ref('inventory').set(inventory);
      database.ref('transactions').set(transactions);
    }

    // Hàm tải dữ liệu từ Firebase
    function loadData() {
      database.ref('inventory').on('value', (snapshot) => {
        inventory = snapshot.val() || {};
        updateUI();
      });
      database.ref('transactions').on('value', (snapshot) => {
        transactions = snapshot.val() || [];
        updateUI();
      });
    }

    // Hàm tính toán lại tồn kho từ lịch sử giao dịch
    function recalculateInventory() {
      inventory = {};
      transactions.forEach(t => {
        if (t.type === 't') {
          inventory[t.code] = t.amount;
        } else if (t.type === 'n') {
          inventory[t.code] = (inventory[t.code] || 0) + t.amount;
        } else if (t.type === 'x') {
          inventory[t.code] = (inventory[t.code] || 0) - t.amount;
        }
      });
    }

    // Cập nhật giao diện
    function updateUI() {
      const inventoryBody = document.getElementById('inventory');
      inventoryBody.innerHTML = '';
      for (const [code, amount] of Object.entries(inventory)) {
        const row = `<tr><td>${code}</td><td>${amount} m</td></tr>`;
        inventoryBody.innerHTML += row;
      }

      const transactionsBody = document.getElementById('transactions');
      transactionsBody.innerHTML = '';
      transactions.forEach((t, index) => {
        const row = `
          <tr>
            <td>${t.date}</td>
            <td>${t.displayType}</td>
            <td>${t.code}</td>
            <td>${t.amount} m</td>
            <td>${t.stock} m</td>
            <td>
              <button class="btn btn-sm btn-warning action-btn" onclick="editTransaction(${index})">Sửa</button>
              <button class="btn btn-sm btn-danger action-btn" onclick="deleteTransaction(${index})">Xóa</button>
            </td>
          </tr>`;
        transactionsBody.innerHTML += row;
      });
    }

    // Xử lý lệnh text
    function processTextCommand() {
      const command = document.getElementById('commandInput').value.toLowerCase().trim();
      const date = document.getElementById('commandDate').value || today;
      if (!command) {
        document.getElementById('output').textContent = 'Vui lòng nhập lệnh!';
        return;
      }
      document.getElementById('output').textContent = 'Lệnh: ' + command;
      document.getElementById('commandInput').value = ''; // Xóa ô nhập
      processCommand(command, date);
    }

    // Xử lý lệnh từ form
    function processFormCommand() {
      const type = document.getElementById('formType').value;
      const code = document.getElementById('formCode').value.trim().toUpperCase();
      const amount = parseInt(document.getElementById('formAmount').value);
      const date = document.getElementById('formDate').value || today;
      
      if (!code || isNaN(amount) || amount <= 0) {
        document.getElementById('output').textContent = 'Vui lòng nhập đầy đủ mã vải và số mét hợp lệ!';
        return;
      }

      const command = `${type} ${code} ${amount}`;
      document.getElementById('output').textContent = 'Lệnh: ' + command;
      document.getElementById('formCode').value = '';
      document.getElementById('formAmount').value = '';
      processCommand(command, date);
    }

    // Gửi lệnh bằng phím Enter (cho ô nhập text)
    document.getElementById('commandInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        processTextCommand();
      }
    });

    // Xử lý lệnh
    function processCommand(command, date) {
      // Định dạng ngày thành DD/MM/YYYY
      const formattedDate = new Date(date).toLocaleDateString('vi-VN');
      let match;

      // Lệnh tồn kho: "t a01 100", "t a01 100m", ...
      if (match = command.match(/(?:hôm nay.*)?t\s+(\w+)\s+(\d+)(?:\s*mét|\s*m)?/i)) {
        const code = match[1].toUpperCase();
        const amount = parseInt(match[2]);
        pendingCommand = { date: formattedDate, type: 't', displayType: 'tồn', code, amount, stock: amount };
        showConfirmation(`Xác nhận cập nhật tồn kho mã ${code} là ${amount} mét vào ngày ${formattedDate}?`);
      }
      // Lệnh nhập: "n a01 50", "n a01 50m", ...
      else if (match = command.match(/n\s+(\w+)\s+(\d+)(?:\s*mét|\s*m)?/i)) {
        const code = match[1].toUpperCase();
        const amount = parseInt(match[2]);
        const newStock = (inventory[code] || 0) + amount;
        pendingCommand = { date: formattedDate, type: 'n', displayType: 'nhập', code, amount, stock: newStock };
        showConfirmation(`Xác nhận nhập mã ${code} ${amount} mét vào ngày ${formattedDate}? Tồn kho sẽ là ${newStock} mét.`);
      }
      // Lệnh xuất: "x a01 30", "x a01 30m", ...
      else if (match = command.match(/x\s+(\w+)\s+(\d+)(?:\s*mét|\s*m)?/i)) {
        const code = match[1].toUpperCase();
        const amount = parseInt(match[2]);
        if ((inventory/code] || 0) >= amount) {
          const newStock = (inventory[code] || 0) - amount;
          pendingCommand = { date: formattedDate, type: 'x', displayType: 'xuất', code, amount, stock: newStock };
          showConfirmation(`Xác nhận xuất mã ${code} ${amount} mét vào ngày ${formattedDate}? Tồn kho sẽ là ${newStock} mét.`);
        } else {
          document.getElementById('output').textContent = `Lỗi: Không đủ tồn kho mã ${code}. Tồn kho hiện tại: ${inventory[code] || 0} mét.`;
        }
      } else {
        document.getElementById('output').textContent = 'Lệnh không hợp lệ: ' + command;
      }
    }

    // Hiển thị popup xác nhận
    function showConfirmation(message) {
      document.getElementById('confirmationMessage').textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      modal.show();

      // Xử lý nút xác nhận
      document.getElementById('confirmButton').onclick = function() {
        if (pendingCommand) {
          if (pendingCommand.type === 't') {
            inventory[pendingCommand.code] = pendingCommand.amount;
            transactions.push(pendingCommand);
          } else if (pendingCommand.type === 'n') {
            inventory[pendingCommand.code] = pendingCommand.stock;
            transactions.push(pendingCommand);
          } else if (pendingCommand.type === 'x') {
            inventory[pendingCommand.code] = pendingCommand.stock;
            transactions.push(pendingCommand);
          }
          saveData();
          updateUI();
          modal.hide();
          pendingCommand = null;
          document.getElementById('output').textContent = 'Đã cập nhật thành công!';
        }
      };
    }

    // Xóa giao dịch
    function deleteTransaction(index) {
      if (confirm('Bạn có chắc muốn xóa giao dịch này?')) {
        transactions.splice(index, 1);
        recalculateInventory();
        saveData();
        document.getElementById('output').textContent = 'Đã xóa giao dịch!';
      }
    }

    // Chỉnh sửa giao dịch
    function editTransaction(index) {
      editingIndex = index;
      const t = transactions[index];
      document.getElementById('editType').value = t.type;
      document.getElementById('editCode').value = t.code;
      document.getElementById('editAmount').value = t.amount;
      // Chuyển định dạng ngày DD/MM/YYYY sang YYYY-MM-DD
      const [day, month, year] = t.date.split('/');
      document.getElementById('editDate').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    }

    // Lưu giao dịch đã chỉnh sửa
    document.getElementById('saveEditButton').onclick = function() {
      const type = document.getElementById('editType').value;
      const code = document.getElementById('editCode').value.trim().toUpperCase();
      const amount = parseInt(document.getElementById('editAmount').value);
      const date = document.getElementById('editDate').value;

      if (!code || isNaN(amount) || amount <= 0) {
        document.getElementById('output').textContent = 'Vui lòng nhập đầy đủ mã vải và số mét hợp lệ!';
        return;
      }

      const formattedDate = new Date(date).toLocaleDateString('vi-VN');
      const displayType = type === 't' ? 'tồn' : type === 'n' ? 'nhập' : 'xuất';
      let stock = amount;
      if (type === 'n') {
        stock = (inventory[code] || 0) + amount - (transactions[editingIndex].type === 'n' ? transactions[editingIndex].amount : 0);
      } else if (type === 'x') {
        stock = (inventory[code] || 0) - amount + (transactions[editingIndex].type === 'x' ? transactions[editingIndex].amount : 0);
      }

      transactions[editingIndex] = { date: formattedDate, type, displayType, code, amount, stock };
      recalculateInventory();
      saveData();
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      document.getElementById('output').textContent = 'Đã chỉnh sửa giao dịch!';
      editingIndex = null;
    };

    // Tải dữ liệu khi khởi động
    loadData();
  </script>
</body>
</html>
